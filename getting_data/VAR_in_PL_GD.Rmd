---
title: "VAR in PL"
author: "Pedro Alan Velázquez Romero"
date: "5/3/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r librerias, include = FALSE}
#librerias a utilizar 
#install.packages(c("dplyr","ggplot2","tidyr","httr","XML","rvest","xml2","tidyverse","robotstxt",
            #       "urltools"))
library(dplyr)
library(ggplot2)
library(tidyr)
library(httr)
library(XML)
library(rvest)
library(xml2)
library(tidyverse)
library(robotstxt)
library(urltools)
library(XML)
library(methods)
```

```{r Funciones}
#Funciones a utilizar

is_big_six <- function(team_name){
  big_six_teams <- c('arsenal','chelsea','liverpool','manchester city','manchester united','tottenham hotspur')
  if(tolower(team_name) %in% big_six_teams)
    big_six <- 1
  else 
    big_six <- 0
  
  big_six
}

teams_ovrt_names_points <- function(array_data,is_21_22 = F){
  if(is_21_22){
    #nombres importantes del tipo de decisión de VAR
    var_names <- c('VAR overturns - net score','VAR overturns - decisions against','VAR overturns - decisions for')
    }else{
    #nombres importantes del tipo de decisión de VAR
    var_names <- c('VAR overturns (net score)','VAR overturns - decisions for','VAR overturns - decisions against')
    }
  #Vector para guardar la posición de cada nombre de decisión de VAR dentro del array de datos
  var_names_pos <- NULL
  #Vector para guardar el nombre de cada equipo
  ovrt_team_points <- NULL 
  #Vector para guardar los puntos asociados a cada equipo por tipo de decisión de VAR
  ovrt_team_names <- NULL
  
  #Loop para obtener los números de índice de los nombres del VAR dentro del array de datos
  for (x in 1:length(var_names)) {
    name_pos <- which(array_data == var_names[x])
    var_names_pos <- c(var_names_pos,name_pos)
  }
  
  for (y in 1:length(var_names_pos)) {
    if(y == 3){
      for(w in seq(var_names_pos[y] + 1,length(array_data),by=2)){
        ovrt_team_names <- c(ovrt_team_names,array_data[w])
        ovrt_team_points <- c(ovrt_team_points,as.integer(array_data[w+1]))
      }
    } else {
      for(w in seq(var_names_pos[y] + 1,var_names_pos[y+1] - 1,by=2)){
        ovrt_team_names <- c(ovrt_team_names,array_data[w])
        ovrt_team_points <- c(ovrt_team_points,as.integer(array_data[w+1]))
      }
    }
  }
  
  return_list = list("names" = ovrt_team_names, "points" = ovrt_team_points)
  
  return(return_list)
}

format_ovrt_details <- function(array_data){
  details_ovrt <- NULL
  
  for(i in 1:length(array_data))
    details_ovrt <- c(details_ovrt,str_split(array_data[i],"\n",simplify = T))
  
  details_ovrt_data <- NULL
  
  for(j in 1:length(details_ovrt)){
    data_trim <- str_trim(details_ovrt[j])
    if(str_length(data_trim) > 0)
      details_ovrt_data <- c(details_ovrt_data,data_trim)
  }
  
  return(details_ovrt_data)
}

teams_ovrt_details <- function(array_data){
  #Creamos los vectores en donde vamos a guardar todos los valores numéricos de los overturns 
  #para todos los equipos en las dos temporadas
  des_ovrt <- NULL
  indices_overturns <- which(array_data == "Overturns:")
  num_indices <- length(indices_overturns)
  
  #Iniciamos los loops en donde vamos a recorrer todos los datos de la página web y solo nos quedamos
  #con los valores numéricos, todo esto para las dos temporadas. Se hacen en dos loops diferentes 
  #porque el tamaño del vector es diferente entre ambas temporadas
  
  for(m in 1:num_indices){
    if(m == num_indices){
      #a partir del overturn buscamos el indice del siguiente "Game:"
      inicio_seq <- indices_overturns[m]
      fin_seq <- length(array_data)
      indices_games <- which(array_data[inicio_seq:fin_seq] == 'Game:')
      lim_seq <- indices_games[1] - 1
      aux_cont <- 0
      for(n in seq(inicio_seq+1,inicio_seq+lim_seq,by=2)){
        metrica_ovrt <- array_data[n]
        if(grepl("/",metrica_ovrt)){
          indice_caracter <- unlist(gregexpr("/",metrica_ovrt))
          metrica1 <- as.integer(substr(metrica_ovrt,1,indice_caracter-1))
          metrica2 <- as.integer(substr(metrica_ovrt,indice_caracter+1,nchar(metrica_ovrt)))
          net_metrica <- metrica1 - metrica2
          des_ovrt <- c(des_ovrt,net_metrica)
          aux_cont <- aux_cont + 1
        } else {
          des_ovrt <- c(des_ovrt,as.integer(metrica_ovrt))
          aux_cont <- aux_cont + 1
        }
      }
      if(aux_cont < 11){
        des_ovrt <- c(des_ovrt,rep(2019,11-aux_cont))
      }
    } else {
      #a partir del overturn buscamos el indice del siguiente "Game:"
      inicio_seq <- indices_overturns[m]
      fin_seq <- indices_overturns[m+1]
      indices_games <- which(array_data[inicio_seq:fin_seq] == 'Game:')
      lim_seq <- indices_games[1] - 1
      aux_cont <- 0
      for(n in seq(inicio_seq+1,inicio_seq+lim_seq,by=2)){
        metrica_ovrt <- array_data[n]
        if(grepl("/",metrica_ovrt)){
          indice_caracter <- unlist(gregexpr("/",metrica_ovrt))
          metrica1 <- as.integer(substr(metrica_ovrt,1,indice_caracter-1))
          metrica2 <- as.integer(substr(metrica_ovrt,indice_caracter+1,nchar(metrica_ovrt)))
          net_metrica <- metrica1 - metrica2
          des_ovrt <- c(des_ovrt,net_metrica)
          aux_cont <- aux_cont + 1
        } else {
          des_ovrt <- c(des_ovrt,as.integer(metrica_ovrt))
          aux_cont <- aux_cont + 1
        }
      }
      if(aux_cont < 11){
        des_ovrt <- c(des_ovrt,rep(2019,11-aux_cont))
      }
    }
  }
  #20_21 : net_penalties (for - against)
  #21_22 : net_penalties (for - against) , net_red_cards (for - against)
  return(des_ovrt)
}

#función para meter los valores de la función anterior en un dataframe 
teams_ovrt_details_df <- function(data_array,teams_names,season){
  #Overturns totales del equipo
  overturns_array <- NULL
  #leading goals for
  lgf_array <- NULL
  #disallowed goals for  
  dgf_array <- NULL
  #leading goals against
  lga_array <- NULL
  #disallowed goals against
  dga_array <- NULL
  #net goal score
  ngs_array <- NULL
  #subjective decisions for
  sdf_array <- NULL
  #subjective decisions against
  sda_array <- NULL
  #net subjective score
  nsc_array <- NULL
  #penalties net score (for - against)
  pns_array <- NULL
  #red cards net score (for - against)
  rcns_array <- NULL

  #ya que tenemos los vectores creados entonces recorremos el vector con todos los valores numéricos
  #y vamos guardando cada dato en su respectivo vector. Esto aplica para ambas temporadas
  
  tamano_array <- length(data_array)
  num_metricas <- 11
  
  for (x in seq(1,tamano_array,by = num_metricas)) {
    overturns_array <- c(overturns_array,as.integer(data_array[x]))
    lgf_array <- c(lgf_array,as.integer(data_array[x+1]))
    dgf_array <- c(dgf_array,as.integer(data_array[x+2]))
    lga_array <- c(lga_array,as.integer(data_array[x+3]))
    dga_array <- c(dga_array,as.integer(data_array[x+4]))
    ngs_array <- c(ngs_array,as.integer(data_array[x+5]))
    sdf_array <- c(sdf_array,as.integer(data_array[x+6]))
    sda_array <- c(sda_array,as.integer(data_array[x+7]))
    nsc_array <- c(nsc_array,as.integer(data_array[x+8]))
    pns_array <- c(pns_array,as.integer(data_array[x+9]))
    rcns_array <- c(rcns_array,as.integer(data_array[x+10]))
  }

  num_equipos <- tamano_array / num_metricas
  season_array <- c(rep(season,num_equipos))
  #Ya que tenemos los vectores individuales de cada métrica entonces creamos la tabla de los 
  #equipos con estas nuevas métricas 
  des_df <- data.frame("season" = season_array,
                     "team" = teams_names,
                     "ovrt" = overturns_array,"lgf" = lgf_array,"dgf" = dgf_array,
                     "lga" = lga_array,"dga" = dga_array,"ngs" = ngs_array,
                     "sdf" = sdf_array,"sda" = sda_array,"nsc" = nsc_array,
                     'pns' = pns_array,"rcns" = rcns_array)
  
  return(des_df)
}

#funcion para dividir los detalles de incidentes del VAR por cada equipo
var_desc_arrays <- function(data_array,data_teams_names){
  #Vector en donde guardaremos el detalle del equipo al que se enfrentó, localia y fecha del incidente
  game_detail <- NULL
  #Vector en donde guardaremos la descripción del incidente y el tipo de este (a favor o en contra)
  incident_detail <- NULL
  #Vector auxiliar que nos va a ayudar a delimitar los incidentes de cada equipo
  aux_index <- NULL

  #Loop que nos sirve para guardar el índice de comienzo de cada equipo, 
  #la descripción de la localía y fecha y la descripción de los incidentes 
  #por equipo de la temporada correspondiente
  for(s in 1:length(data_array)){
    if(data_array[s] == "Overturns:")
      #Guardamos el índice en donde inicia las descripciones de cada equipo
      aux_index <- c(aux_index,s)
    else if(data_array[s] == "Game:")
      #Guardamos el detalle del equipo contrario, fecha y localía
      game_detail <- c(game_detail,data_array[s+1])
    else if(data_array[s] == "Incident:")
      #Guardamos la descripción del incidente y el tipo de éste
      incident_detail <- c(incident_detail,data_array[s+1])
  }
  
  #agregamos el tamaño del vector de la data al vector auxiliar para referencia
  aux_index <- c(aux_index,length(data_array))
  
  #Vector en donde guardaremos la cuenta del total de incidentes por equipo
  cuenta_equipo <- NULL
  
  #Loop en donde guardamos el número total de incidentes por equipo para la temporada correspondiente
  for(t in 1:(length(aux_index)-1)){
    #Contador auxiliar que contará el número de incidentes por equipo
    cont <- 0
    for(u in seq(aux_index[t],aux_index[t+1])){
      #verificamos si el dato que nos encontramos es un incidente
      if(data_array[u] == "Incident:")
        #Si si es un incidente entonces aumentamos la cuenta en el auxiliar
        cont <- cont + 1
    }
    #Al final guardamos la cuenta total de incidentes por equipo en el vector nulo 
    cuenta_equipo <- c(cuenta_equipo,cont)
  }
  
  #Vectores que guardaran los nombres de los equipos repetidos
  teams_names_rep <- NULL

  #Iniciamos el loop en donde ya repetimos el nombre de los equipos
  for(v in 1:length(cuenta_equipo)){
    teams_names_rep <- c(teams_names_rep,rep(data_teams_names[v],cuenta_equipo[v]))
  }
  
  lista_vectores <- list("aux_index" = aux_index,"game_detail" = game_detail,
                         "incident_detail" = incident_detail,"teams_names_rep" = teams_names_rep)
  
  return(lista_vectores)
}

var_desc <- function(data_array){
  #Vector en donde guardaremos la descripción como tal del incidente
  desc_incident <- NULL
  #Vector en donde guardaremos el minuto en que ocurrió el incidente
  min_incident <- NULL
  #Vector en donde guardaremos el tipo de incidente
  type_incident <- NULL
  
  for(y in 1:length(data_array)){
    #Por cada descripción de incidente, obtenemos el o los números de índice en donde 
    #se encuentra alguna comna, esto porque lo que separa la descripción del incidente y el 
    #minuto en donde ocurrio es una coma
    coma_1 <- str_locate_all(data_array[y],",")
    #Por cada descripción de incidente, obtenemos el o los números de índice en donde 
    #se encuentra algún guión, esto porque lo que separa el minuto del incidente y el 
    #tipo del mismo es un guión
    guion_1 <- str_locate_all(data_array[y],"-")
    
    #en caso de que si haya comas, nos traemos la posición de la última coma
    coma_2 <- coma_1[[1]][dim(coma_1[[1]])[1]]
    #en caso de que si haya guion, nos traemos la posición del último guión
    guion_2 <- guion_1[[1]][dim(guion_1[[1]])[1]]
    
    #numero de comas que tiene la descripcion
    num_comas <- dim(coma_1[[1]])
    #numero de guiones que tiene la descripcion
    num_guiones <- dim(guion_1[[1]])
    
    #nos fijamos si la descripcion no tiene comas
    if(num_comas[1] == 0){
      #si no tiene comas quiere decir que viene solamente la pura descripción en texto
      desc_incident <- c(desc_incident,data_array[y])
      #no contiene el minuto
      min_incident <- c(min_incident,0)
      #no contiene el tipo de incidente
      type_incident <- c(type_incident,"None")
    #ahora nos fijamos si contiene el minuto
    } else if (!grepl("minute",data_array[y])){
      #Traemos la pura descripción del incidente
      desc_incident <- c(desc_incident,substr(data_array[y],1,guion_2-2))
      #Traemos el puro tipo de incidente
      type_incident <- c(type_incident,substr(data_array[y],guion_2+2,str_length(data_array[y])))
      #En este caso no hay minuto de incidente entonces le asignamos un cero
      min_incident <- c(min_incident,0)
    #en este caso es donde si tiene descripción, minuto y tipo
    } else {
      #Traemos la pura descripción del incidente
      desc_incident <- c(desc_incident,substr(data_array[y],1,coma_2-1))
      #Traemos el puro tipo de incidente
      type_incident <- c(type_incident,substr(data_array[y],guion_2+2,str_length(data_array[y])))
      #Traemos el puro minuto del incidente
      min_texto <- substr(data_array[y],coma_2+2,guion_2-2)
      #obtenemos la posición del espacio
      espacio <- str_locate(min_texto, " ")[1]
      #nos quedamos con el puro número
      min_entero <- as.integer(substr(min_texto,1,espacio-3))
      #guardamos el minuto en el array
      min_incident <- c(min_incident,min_entero)
    }
  }
  
  lista_descripciones <- list("description" = desc_incident, "minute" = min_incident, 
                              "type" = type_incident)
  
  return(lista_descripciones)
}

var_desc_teams <- function(data_array,aux,data_game_detail){
  #Vector en donde guardaremos los nombres de los equipos contrincantes
  juegos <- NULL
  #Vector en donde guardaremos si es que el equipo es local o visitante
  localia <- NULL
  #Vector en donde guardaremos la fecha del partido en donde suscitó el incidente
  fecha <- NULL
  #Variable que nos ayudará a controlar el número de incidentes que se suscitaron en un 
  #mismo partido
  suma <- 0
  
  #Loop en donde separaremos el nombre del equipo contrincante, el tipo de localia y la fecha del incidente
  for(z in 1:(length(aux)-1)){
    #Vector que nos va a ayudar a concatenar los índices en donde se encuentra un partido para cada equipo
    vector1 <- NULL
    #Loop en donde obtenemos el índice donde se encuentra cada partido para cada equipo
    for(w in seq(aux[z],aux[z+1])){
      #verificamos que sea un partido
      if(data_array[w] == 'Game:'){
        #Si sí es un partido entonces guardamos el número de índice
        vector1 <- c(vector1,w)
      }
    }
    #Al final, cuando ya tengamos todos los índices, concatenamos el último para abarcar todos los juegos
    vector1 <- c(vector1,aux[z+1])
    #Vector nulo que nos ayudará a saber cuántos incidentes hubo dentro de cada juego para cada equipo
    cont_total <- NULL
    #Loop para guardar el número de incidentes para cada partido de cada equipo
    for(t in 1:(length(vector1)-1)){
      #Variable que va a acumular el número de incidentes por partido
      cont_inc <- 0
      #Loop que nos va a ayudar a identificar los incidentes por partido y sumarlos
      for(u in seq(vector1[t],vector1[t+1])){
        #Verificamos que sea un incidente
        if(data_array[u] == 'Incident:'){
          #Si sí es un incidente entonces incrementamos la cuenta
          cont_inc <- cont_inc + 1
        }
      }
      #Al final concatenamos el total de incidentes por cada partido
      cont_total <- c(cont_total,cont_inc)
    }
    #Ya que tenemos el conteo de incidentes por cada partido de cada equipo, hacemos el loop para 
    #entonces si separar todos los datos del partido (equipo contrincante, localia y fecha)
    for(v in 1:length(cont_total)){
      #Encontramos el índice en donde se encuentra el primer paréntesis
      parentesis_1 <- str_locate(data_game_detail[suma+v],"\\(")[1]
      #Encontramos el índice en donde se encuentra el segundo paréntesis
      parentesis_2 <- str_locate(data_game_detail[suma+v],"\\)")[1]
      #Encontramos el índice en donde se encuentra el punto y coma
      punto_coma <- str_locate(data_game_detail[suma+v],";")[1]
      #Nos traemos el nombre del equipo contrincante y lo repetimos por el número de 
      #incidentes que tuvo en un mismo partido
      juegos <- c(juegos,rep(substr(data_game_detail[suma+v],1,parentesis_1-2),cont_total[v]))
      #Nos traemos la localia y lo repetimos por el número de incidentes que tuvo en un mismo partido
      localia <- c(localia,rep(substr(data_game_detail[suma+v],parentesis_1+1,punto_coma-1),
                               cont_total[v]))
      #Nos traemos la fecha del partido y lo repetimos por el número de incidentes que tuvo en un 
      #mismo partido
      fecha <- c(fecha,rep(substr(data_game_detail[suma+v],punto_coma+2,parentesis_2-1),
                           cont_total[v]))
    }
    #Aumentamos la variable para controlar los datos a repetir
    suma <- suma + length(cont_total)
  }
  
  lista_equipos <- list("teams" = juegos,"venue_type" = localia, "date" = fecha)
  
  return(lista_equipos)
}

#funcion para que, a partir del df de las descripciones de var, desglozar los campos team1 y team2 
#en donde ya se considera al team1 como el local y al team2 como el visitante
var_desc_1 <- function(data_frame){
  #Vectores que nos ayudarán a guardar los equipos locales y visitantes
  team1 <- NULL
  team2 <- NULL
  
  for(a in 1:dim(data_frame)[1]){
    #Transformamos el primer equipo en character
    equipo1 <- as.character(data_frame$team1[a])
    #Transformamos el segundo equipo en character
    equipo2 <- as.character(data_frame$team2[a])
    #Transformamos el indicador de localia en character
    local_eq <- as.character(data_frame$home.away[a])
    #Verificamos si el indicador de localia dice que el primer equipo es local
    if(local_eq == 'H'){
      #Si sí es local entonces agregamos el primer equipo al vector de los locales
      team1 <- c(team1,equipo1)
      #Si sí es local entonces agregamos el segundo equipo al vector de los visitantes
      team2 <- c(team2,equipo2)
    } else {
      #Si no es local entonces agregamos el segundo equipo al vector de los locales
      team1 <- c(team1,equipo2)
      #Si no es local entonces agregamos el primer equipo al vector de los visitantes
      team2 <- c(team2,equipo1)
    }
  }
  
  lista_equipos <- list("local_team" = team1, "away_team" = team2)
  
  return(lista_equipos)
}

sub_value_df <- function(df_column,old_value,new_value){
  for(x in 1:length(df_column)){
    if(df_column[x] == old_value)
      df_column[x] = new_value
  }
  
  return(df_column)
}
```

Esta es la primera versión del documento en donde se harán los cálculos para el análisis del VAR en el fútbol. A partir de aquí se va a empezar con un análisis descriptivo de los datos, además de reconocer los datos verdaderamente valiosos con los que se trabajará.

El primer acercamiento por supuesto es sobre el VAR como nueva medida en el fútbol, de aquí que sale el repentino interés de querer saber lo siguiente:

1. En qué fecha se implementó el VAR? A partir de ahí podemos hacer comparaciones entre métricas de equipos antes y después del VAR
2. Si se puede conseguir datos del VAR en la PL entonces también podemos comparar el efecto del VAR junto al efecto que trajo consigo la pandemia del COVID-19.

Implementación del VAR en la PL: **2018 empieza como piloto, se implementó en 2019 de manera oficial**

Propuestas de métricas para medir la ineficiencia/eficiencia del VAR (Arturo Brizio, presidente de la Comisión de Árbitros en México):

1. La unificación de procedimientos
2. La línea de intervención (equilibrio entre poco y nunca, solamente when necessary)
3. Tiempo de revisión (el promedio hasta marzo 2021 es de 1.5 mins, el máximo es 9 mins)
4. Medidas PEGII: Penal, Expulsión, Gol, Identidad errónea e Incidente no visto por el árbitro

Esta criteria trasladada en la PL varia un poco debido a que en esa liga se toman en cuenta más variables, la referencia de esto es el siguiente link proveniente de la página oficial de la PL: https://www.premierleague.com/news/1293321

Fuente: https://www.marca.com/claro-mx/futbol/liga-mx/2021/03/25/605cfb42ca4741d5138b4612.html

VAR definición: https://www.marca.com/claro-mx/futbol/liga-mx/2018/10/18/5bc8a11a268e3ebb268b45ce.html

## DF1: premier_league

Si obtenemos el documento directamente de la página de GitHub de FiveThirtyEight se tienen los partidos actualizados al día.

```{r read fivethirtyeight data}
#al parecer aquí ya se encuentran desde 2016 hasta hoy, se actualiza cada semana
url <- "https://projects.fivethirtyeight.com/soccer-api/club/spi_matches.csv"
football_matches <- read.csv(url,fileEncoding = 'UTF-8',skipNul = T)
premier_league <- football_matches %>% filter(league == "Barclays Premier League")
#seasons <- unique(premier_league$season)
```

En el caso de la PL, como se trata de torneos largos, aquí no se mete la variable de una "liguilla" a comparación con la liga de México. Aquí se toman en cuenta todos los partidos y lo que cambian son los ascendidos y descendidos en cada temporada.

Aquí se considerarán dos nuevas variables, a saber, las siguientes:

- after_covid: flag que denota si el partido se jugó en pandemia o pre-pandemia. La PL se suspendió un 13 de marzo de 2020 según ESPN
- is_VAR: flag que denota si en el partido ya está implemnentado el VAR o no. EL VAR se implementó en la PL a partir de la temporada 19/20, es decir, a partir del 9 de agosto de 2019.

```{r premier_league,include=FALSE}
#Creamos otra variable para determinar en qué momento inició COVID
premier_league <- premier_league %>% mutate(after_covid = if_else(as.POSIXct(date) > as.POSIXct('2020-03-13'),1,0))
#Creamos la variable que nos indica si en el partido estuvo presente el VAR
premier_league <- premier_league %>% mutate(is_VAR = if_else(as.POSIXct(date) > as.POSIXct('2019-08-08'),1,0))
#Creamos la variable en donde nos dice si el equipo local es del big six
premier_league$team1 <- sapply(premier_league$team1,as.character)
premier_league$team2 <- sapply(premier_league$team2,as.character)

premier_league['big_six_h'] <- sapply(premier_league$team1, is_big_six)
#Creamos la variable en donde nos dice si el equipo visitante es del big six
premier_league['big_six_a'] <- sapply(premier_league$team2, is_big_six)
#Creamos la variable en donde nos dice si el equipo local o visitante (cualquiera de los dos) es del big six
premier_league <- premier_league %>% mutate(big_six = if_else(big_six_h == 1 | big_six_a == 1,1,0))
#Modificamos la variable season para tener un estándar de esa variable en todas las tablas
premier_league$season <- sapply(premier_league$season,as.character)
lista_seasons <- NULL
for(x in 1:dim(premier_league)[1]){
  season_comp_1 <- substr(premier_league$season[x],3,4)
  season_comp_2 <- as.character(as.integer(season_comp_1) + 1)
  season_format <- paste(season_comp_1,season_comp_2,sep = "/")
  lista_seasons <- c(lista_seasons,season_format)
}
premier_league$season <- lista_seasons

#-------------queda pendiente la variable de intercepciones del VAR
```

Se cuenta con un archivo en donde se denotan las intervenciones del VAR en la PL de la temporada 19/20 (la primera temporada en que se implementó) y se va a hacer un data set de esos records a continuación.

```{r ovrt_df,include=FALSE}
#Empezamos el proceso para obtener los datos de las intervenciones del VAR en temporadas 19/20 y 20/21 de la PL

#Leemos primero todo el archivo html de la temporada 19/20
VAR_19_20 <- htmlParse("/Users/pedrovela/Documents/Git_repos/var_epl/getting_data/VAR_in_PL_19-20.html")
#Leemos primero todo el archivo html de la temporada 20/21
VAR_20_21 <- htmlParse("/Users/pedrovela/Documents/Git_repos/var_epl/getting_data/VAR_in_PL_20-21.html")
#Leemos primero todo el archivo html de la temporada 21/22
VAR_21_22 <- htmlParse("/Users/pedrovela/Documents/Git_repos/var_epl/getting_data/VAR_in_PL_21-22.html")

#Nos traemos las tablas de overturns del VAR hacia todos los equipos para la 19/20, los cuales sabemos que están en los nodos de la forma <aside class = "inline editorial float-r">
var_overturns_19_20 <- getNodeSet(VAR_19_20, "//aside[@class='inline editorial float-r']") %>% sapply(., xmlValue)
#Nos traemos las tablas de overturns del VAR hacia todos los equipos para la 20/21, los cuales sabemos que están en los nodos de la forma <aside class = "inline editorial float-r">
var_overturns_20_21 <- getNodeSet(VAR_20_21, "//aside[@class='inline editorial float-r']") %>% sapply(., xmlValue)
#Nos traemos las tablas de overturns del VAR hacia todos los equipos para la 21/22, los cuales sabemos que están en los nodos de la forma <aside class = "inline editorial float-r">
var_overturns_21_22 <- getNodeSet(VAR_21_22, "//aside[@class='inline editorial float-r']") %>% sapply(., xmlValue)

#Nos traemos los nombres de los equipos de la PL de la 19/20 con sus puntos a favor o en contra a raíz de decisiones del VAR (netscore), los cuales sabemos que están en nodos de la forma <h2>
teams_19_20 <- getNodeSet(VAR_19_20, "//h2") %>% sapply(., xmlValue)
#Nos traemos los nombres de los equipos de la PL de la 20/21 con sus puntos a favor o en contra a raíz de decisiones del VAR (netscore), los cuales sabemos que están en nodos de la forma <h2>
teams_20_21 <- getNodeSet(VAR_20_21, "//h2") %>% sapply(., xmlValue)
#Nos traemos los nombres de los equipos de la PL de la 21/22 con sus puntos a favor o en contra a raíz de decisiones del VAR (netscore), los cuales sabemos que están en nodos de la forma <h2>
teams_21_22 <- getNodeSet(VAR_21_22, "//h2") %>% sapply(., xmlValue)

#Nos traemos el detalle de las decisiones del VAR por cada equipo de la 19/20, los cuales sabemos que están en nodos del tipo <p>
details_var_19_20 <- getNodeSet(VAR_19_20, "//p") %>% sapply(., xmlValue)
#Nos traemos el detalle de las decisiones del VAR por cada equipo de la 20/21, los cuales sabemos que están en nodos del tipo <p>
details_var_20_21 <- getNodeSet(VAR_20_21, "//p") %>% sapply(., xmlValue)
#Nos traemos el detalle de las decisiones del VAR por cada equipo de la 21/22, los cuales sabemos que están en nodos del tipo <p>
details_var_21_22 <- getNodeSet(VAR_21_22, "//p") %>% sapply(., xmlValue)

#Empezamos a tratar con los datos obtenidos arriba para solo quedarnos con la info importante

#Se va a guardar todos los datos "servibles" o "útiles" dentro de un solo array
ovrt_19_20 <- NULL
#Vamos a hacer un loop para guardar los datos acerca de los overturns de los equipos de la 19/20
for (a in 1:length(var_overturns_19_20)) {
  #Guardamos cada jornada como una matriz
  ovrt_19_20 <- c(ovrt_19_20,str_split(var_overturns_19_20[a],"\n",simplify = T))
}

#ya que tenemos los datos de todos los equipos de la 19/20, ahora nos vamos a quedar solamente 
#con los datos útiles, para esto, hacemos un loop, vamos a trimear cada entrada 
#y si la longitud de la entrada después de trimearla es mayor a cero entonces es un dato
#útil y lo guardamos en un nuevo array

#Array en donde vamos a guardar todo
ovrt_data_19_20 <- NULL
#Iniciamos el loop en donde vamos a guardar todos los datos
for (b in 1:length(ovrt_19_20)) {
  #Trimeamos los datos para ver is es que hay datos útiles
  data_trim <- str_trim(ovrt_19_20[b])
  #Si la longitud de lo trimeado es mayor a cero entonces tiene datos útiles
  if(str_length(data_trim) > 0){
    #Guardamos el dato útil en un array 
    ovrt_data_19_20 <- c(ovrt_data_19_20,data_trim)
  }
}

#Hacemos el mismo proceso para los datos de la 20/21

#Se va a guardar todos los datos "servibles" o "útiles" dentro de un solo array
ovrt_20_21 <- NULL
#Vamos a hacer un loop para guardar los datos acerca de los overturns de los equipos de la 20/21
for (c in 1:length(var_overturns_20_21)) {
  #Guardamos cada jornada como una matriz
  ovrt_20_21 <- c(ovrt_20_21,str_split(var_overturns_20_21[c],"\n",simplify = T))
}

#ya que tenemos los datos de todos los equipos de la 20/21, ahora nos vamos a quedar solamente 
#con los datos útiles, para esto, hacemos un loop, vamos a trimear cada entrada 
#y si la longitud de la entrada después de trimearla es mayor a cero entonces es un dato
#útil y lo guardamos en un nuevo array

#Array en donde vamos a guardar todo
ovrt_data_20_21 <- NULL
#Iniciamos el loop en donde vamos a guardar todos los datos
for (d in 1:length(ovrt_20_21)) {
  #Trimeamos los datos para ver is es que hay datos útiles
  data_trim <- str_trim(ovrt_20_21[d])
  #Si la longitud de lo trimeado es mayor a cero entonces tiene datos útiles
  if(str_length(data_trim) > 0){
    #Guardamos el dato útil en un array 
    ovrt_data_20_21 <- c(ovrt_data_20_21,data_trim)
  }
}

#Hacemos el mismo proceso para los datos de la 21/22

#Se va a guardar todos los datos "servibles" o "útiles" dentro de un solo array
ovrt_21_22 <- NULL
#Vamos a hacer un loop para guardar los datos acerca de los overturns de los equipos de la 21/22
for (c in 1:length(var_overturns_21_22)) {
  #Guardamos cada jornada como una matriz
  ovrt_21_22 <- c(ovrt_21_22,str_split(var_overturns_21_22[c],"\n",simplify = T))
}

#ya que tenemos los datos de todos los equipos de la 21/22, ahora nos vamos a quedar solamente 
#con los datos útiles, para esto, hacemos un loop, vamos a trimear cada entrada 
#y si la longitud de la entrada después de trimearla es mayor a cero entonces es un dato
#útil y lo guardamos en un nuevo array

#Array en donde vamos a guardar todo
ovrt_data_21_22 <- NULL
#Iniciamos el loop en donde vamos a guardar todos los datos
for (d in 1:length(ovrt_21_22)) {
  #Trimeamos los datos para ver is es que hay datos útiles
  data_trim <- str_trim(ovrt_21_22[d])
  #Si la longitud de lo trimeado es mayor a cero entonces tiene datos útiles
  if(str_length(data_trim) > 0){
    #Guardamos el dato útil en un array 
    ovrt_data_21_22 <- c(ovrt_data_21_22,data_trim)
  }
}

#la data del season 21/22 viene con un error en los datos de unos equipos, vamos a dividir
#el array para corregir el error
ovrt_data_21_22_aux1 <- ovrt_data_21_22[1:72]
ovrt_data_21_22_aux2 <- ovrt_data_21_22[75:length(ovrt_data_21_22)]
spaces_aux1 <- unlist(gregexpr(' ',ovrt_data_21_22[73]))
last_space_aux1 <- spaces_aux1[length(spaces_aux1)]
team_aux1 <- substr(ovrt_data_21_22[73],1,last_space_aux1-1)
points_aux1 <- substr(ovrt_data_21_22[73],last_space_aux1+1,nchar(ovrt_data_21_22[73]))
spaces_aux2 <- unlist(gregexpr(' ',ovrt_data_21_22[74]))
last_space_aux2 <- spaces_aux2[length(spaces_aux2)]
team_aux2 <- substr(ovrt_data_21_22[74],1,last_space_aux2-1)
points_aux2 <- substr(ovrt_data_21_22[74],last_space_aux2+1,nchar(ovrt_data_21_22[74]))
ovrt_data_21_22 <- c(ovrt_data_21_22_aux1,team_aux1,points_aux1,team_aux2,points_aux2,ovrt_data_21_22_aux2)

#Empezamos a guardar los datos de los overturns en vectores separados para después unirlos en un dataset
ovrt_data_19_20 <- ovrt_data_19_20[1:123]

#Ejecutamos la función para obtener los nombres de los equipos y puntos de VAR sobre el array de datos de cada temporada

teams_ovrt_19_20 <- teams_ovrt_names_points(ovrt_data_19_20)$names
ovrt_points_19_20 <- teams_ovrt_names_points(ovrt_data_19_20)$points
teams_ovrt_20_21 <- teams_ovrt_names_points(ovrt_data_20_21)$names
ovrt_points_20_21 <- teams_ovrt_names_points(ovrt_data_20_21)$points
teams_ovrt_21_22 <- teams_ovrt_names_points(ovrt_data_21_22,T)$names
ovrt_points_21_22 <- teams_ovrt_names_points(ovrt_data_21_22,T)$points

#Vamos a guardar estos tres tipos de overturn en un tres tablas diferntes para cada temporada y así después unirlos en uno solo

#ns = net score
#df = decisions for
#da = decisions against

#Tabla para el overturn "net score"
ns_df <- data.frame("season" = c(rep("19/20",20),rep("20/21",20),rep("21/22",20)), "team" = c(teams_ovrt_19_20[1:20],teams_ovrt_20_21[1:20],teams_ovrt_21_22[1:20]), "ns" = c(ovrt_points_19_20[1:20],ovrt_points_20_21[1:20],ovrt_points_21_22[1:20]))
#Tabla para el overturn "decisions for"
desfor_df <- data.frame("season" = c(rep("19/20",20),rep("20/21",20),rep("21/22",20)), "team" = c(teams_ovrt_19_20[21:40],teams_ovrt_20_21[21:40],teams_ovrt_21_22[21:40]), "df" = c(ovrt_points_19_20[21:40],ovrt_points_20_21[21:40],ovrt_points_21_22[21:40]))
#Tabla para el overturn "decisions against"
desagnst_df <- data.frame("season" = c(rep("19/20",20),rep("20/21",20),rep("21/22",20)), "team" = c(teams_ovrt_19_20[41:60],teams_ovrt_20_21[41:60],teams_ovrt_21_22[41:60]), "da" = c(ovrt_points_19_20[41:60],ovrt_points_20_21[41:60],ovrt_points_21_22[41:60]))
#unimos las tres tablas en una sola basado en la temporada y nombre de equipo
ovrt_df <- inner_join(ns_df,desfor_df,by=c("season","team")) %>% inner_join(.,desagnst_df,by=c("season","team"))
```

Iniciamos el proceso para obtener la descripción de las decisiones del VAR en los partidos de la Premier League en las temporadas 19/20 y 20/21

```{r ovrt_var,include=FALSE}
#Empezamos a tratar con los datos obtenidos sobre los detalles del VAR en cada partido de la PL y entonces
#solo quedarnos con la info importante

details_data_19_20 <- format_ovrt_details(details_var_19_20)
details_data_20_21 <- format_ovrt_details(details_var_20_21)
details_data_21_22 <- format_ovrt_details(details_var_21_22)

#Ahora que ya tenemos los datos "útiles" entonces empezamos a guardar los datos en vectores 

#Empezamos el proceso para traernos la descripciones de decisiones del VAR, primero vamos a obtener
#más métricas relacionadas a los overturns de los equipos 

des_19_20 <- teams_ovrt_details(details_data_19_20)
des_20_21 <- teams_ovrt_details(details_data_20_21)
#en la data de la temporada 20/21 hay un dato de mas en un equipo, se elminará
des_20_21 <- des_20_21[-133]
#en los datos de la temporada 21/22 hay un error en un dato que hace tener varios NA
#separaremos los datos para corregir el error
details_data_21_22_p1 <- details_data_21_22[1:614]
aux_nombre1 <- substr(details_data_21_22[615],1,unlist(gregexpr(":",details_data_21_22[615])))
aux_num1 <- substr(details_data_21_22[615],unlist(gregexpr(":",details_data_21_22[615]))+2,nchar(details_data_21_22[615]))
details_data_21_22_p2 <- details_data_21_22[616:777]
aux_nombre2 <- substr(details_data_21_22[778],1,unlist(gregexpr(":",details_data_21_22[778])))
aux_num2 <- substr(details_data_21_22[778],unlist(gregexpr(":",details_data_21_22[778]))+2,nchar(details_data_21_22[778]))
details_data_21_22_p3 <- details_data_21_22[779:length(details_data_21_22)]
details_data_21_22 <- c(details_data_21_22_p1,aux_nombre1,aux_num1,details_data_21_22_p2,aux_nombre2,aux_num2,details_data_21_22_p3)
des_21_22 <- teams_ovrt_details(details_data_21_22)

#Ahora, tenemos el vector con los valores numéricos de todas las métricas en conjunto
#sin separación, entonces creamos los vectores individuales de cada métrica para separar
#los valores de cada uno. Esto aplica para todas las temporadas

des_df_19_20 <- teams_ovrt_details_df(des_19_20,teams_ovrt_19_20[1:20],"19/20")
des_df_20_21 <- teams_ovrt_details_df(des_20_21,teams_ovrt_20_21[1:20],"20/21")
des_df_21_22 <- teams_ovrt_details_df(des_21_22,teams_ovrt_21_22[1:20],"21/22")

#Unificamos los dfs de cada temporada
des_df <- des_df_19_20 %>% bind_rows(des_df_20_21) %>% bind_rows(des_df_21_22)

#ya que tenemos la tabla creada la unimos con la primera que obtuvimos atrás para ampliar las métricas
#Tabla que contiene las métricas en cuanto overturns por equipo 
ovrt_var <- inner_join(ovrt_df,des_df,by=c("season","team"))
```

Ya que tenemos la tabla con los overturns de cada equipo entonces obtenemos la descripción de cada intervención del VAR para cada equipo

```{r var_details,include=FALSE}
#Empezamos con el proceso para obtener los detalles del VAR en ciertos partidos para cada equipo
#de la PL durante las dos temporadas

#Primero vamos a obtener el detalle de los juegos e incidentes por cada equipo de las dos temporadas

#Vectores auxiliares que nos van a ayudar a delimitar los incidentes de cada equipo
aux_19_20 <- var_desc_arrays(details_data_19_20,teams_ovrt_19_20)$aux_index
aux_20_21 <- var_desc_arrays(details_data_20_21,teams_ovrt_20_21)$aux_index
aux_21_22 <- var_desc_arrays(details_data_21_22,teams_ovrt_21_22)$aux_index

#Vectores en donde guardaremos la descripción del incidente y el tipo de este (a favor o en contra)
incident_detail_19_20 <- var_desc_arrays(details_data_19_20,teams_ovrt_19_20)$incident_detail
incident_detail_20_21 <- var_desc_arrays(details_data_20_21,teams_ovrt_20_21)$incident_detail
incident_detail_21_22 <- var_desc_arrays(details_data_21_22,teams_ovrt_21_22)$incident_detail

#Vectores en donde guardaremos el detalle del equipo al que se enfrentó, localia y fecha del incidente
game_detail_19_20 <- var_desc_arrays(details_data_19_20,teams_ovrt_19_20)$game_detail
game_detail_20_21 <- var_desc_arrays(details_data_20_21,teams_ovrt_20_21)$game_detail
game_detail_21_22 <- var_desc_arrays(details_data_21_22,teams_ovrt_21_22)$game_detail

#Vectores que guardaran los nombres de los equipos repetidos por cada incidente que haya tenido
#en cada temporada
teams_names_rep_19_20 <- var_desc_arrays(details_data_19_20,teams_ovrt_19_20)$teams_names_rep
teams_names_rep_20_21 <- var_desc_arrays(details_data_20_21,teams_ovrt_20_21)$teams_names_rep
teams_names_rep_21_22 <- var_desc_arrays(details_data_21_22,teams_ovrt_21_22)$teams_names_rep

#Ya que tenemos el nombre de los equipos repetidos entonces empezamos por desglozar la descripción
#de los incidentes que tuvo cada equipo, se dividen en la descripción como tal, el minuto en que
#ocurrió el incidente y el tipo de incidente (a favor o en contra)

#Vectores en donde guardaremos la descripción como tal del incidente
desc_incident_19_20 <- var_desc(incident_detail_19_20)$description
desc_incident_20_21 <- var_desc(incident_detail_20_21)$description
desc_incident_21_22 <- var_desc(incident_detail_21_22)$description
#Vectores en donde guardaremos el minuto en que ocurrió el incidente
min_incident_19_20 <- var_desc(incident_detail_19_20)$minute
min_incident_20_21 <- var_desc(incident_detail_20_21)$minute
min_incident_21_22 <- var_desc(incident_detail_21_22)$minute
#Vectores en donde guardaremos el tipo de incidente
type_incident_19_20 <- var_desc(incident_detail_19_20)$type
type_incident_20_21 <- var_desc(incident_detail_20_21)$type
type_incident_21_22 <- var_desc(incident_detail_21_22)$type

#ya que tenemos los minutos en número entonces iniciamos el proceso para desglozar los datos 
#de cada partido en donde ocurrió un incidente por equipo

#Vectores en donde guardaremos los nombres de los equipos contrincantes
juegos_19_20 <- var_desc_teams(details_data_19_20,aux_19_20,game_detail_19_20)$teams
juegos_20_21 <- var_desc_teams(details_data_20_21,aux_20_21,game_detail_20_21)$teams
juegos_21_22 <- var_desc_teams(details_data_21_22,aux_21_22,game_detail_21_22)$teams
#Vectores en donde guardaremos si es que el equipo es local o visitante
localia_19_20 <- var_desc_teams(details_data_19_20,aux_19_20,game_detail_19_20)$venue_type
localia_20_21 <- var_desc_teams(details_data_20_21,aux_20_21,game_detail_20_21)$venue_type
localia_21_22 <- var_desc_teams(details_data_21_22,aux_21_22,game_detail_21_22)$venue_type
#Vectores en donde guardaremos la fecha del partido en donde suscitó el incidente
fechas_19_20 <- var_desc_teams(details_data_19_20,aux_19_20,game_detail_19_20)$date
fechas_20_21 <- var_desc_teams(details_data_20_21,aux_20_21,game_detail_20_21)$date
fechas_21_22 <- var_desc_teams(details_data_21_22,aux_21_22,game_detail_21_22)$date

#Ya que tenemos todos los datos entonces armamos la tabla con todas estas descripciones
var_details <- data.frame("season" = c(rep("19/20",length(incident_detail_19_20)),
                                       rep("20/21",length(incident_detail_20_21)),
                                       rep("21/22",length(incident_detail_21_22))),
                          "team1" = c(teams_names_rep_19_20,teams_names_rep_20_21,
                                      teams_names_rep_21_22),
                          "team2" = c(juegos_19_20,juegos_20_21,juegos_21_22), 
                          "home/away" = c(localia_19_20,localia_20_21,localia_21_22), 
                          "date" = c(fechas_19_20,fechas_20_21,fechas_21_22),
                          "incident" = c(desc_incident_19_20,desc_incident_20_21,desc_incident_21_22),
                          "type" = c(type_incident_19_20,type_incident_20_21,type_incident_21_22),
                          "min" = c(min_incident_19_20,min_incident_20_21,min_incident_21_22))
```

Iniciamos el proceso para hacer una modificación en cuanto a la localía del equipo, se pretende eliminar el indicador de si es local o visitante y manejar solo las variables "team1" y "team2" para denotar localia (team1) o visita (team2)

```{r var_details1,include=FALSE}

#Vector que contiene a equipos locales
team1 <- var_desc_1(var_details)$local_team
#Vector que contiene a equipos visitantes
team2 <- var_desc_1(var_details)$away_team

#Ya que tenemos el cambio de estos equipos según su localia, creamos la nueva tabla ya sin el 
#indicador de localía y con las variables team1 y team2 ya indicando la localia y visitante
var_details1 <- data.frame("season" = c(rep("19/20",length(incident_detail_19_20)),
                                       rep("20/21",length(incident_detail_20_21)),
                                       rep("21/22",length(incident_detail_21_22))),
                          "team1" = team1,
                          "team2" = team2, 
                          "date" = c(fechas_19_20,fechas_20_21,fechas_21_22),
                          "incident" = c(desc_incident_19_20,desc_incident_20_21,desc_incident_21_22),
                          "type" = c(type_incident_19_20,type_incident_20_21,type_incident_21_22),
                          "min" = c(min_incident_19_20,min_incident_20_21,min_incident_21_22))
```

Incluimos nuevas variables en los dataframes

```{r edit previous dfs,include=FALSE}
#Vamos a arreglar algunas variables de los dfs

#homologamos el nombre de los equipos en todos los dfs

#iniciamos con los nombres de los equipos locales
var_details$team1 <- as.character(var_details$team1)
var_details1$team1 <- as.character(var_details1$team1)

var_details$team1 <- sub_value_df(var_details$team1,'Norwich','Norwich City')
var_details1$team1 <- sub_value_df(var_details1$team1,'Bournemouth', 'AFC Bournemouth')
var_details1$team1 <- sub_value_df(var_details1$team1,'Brighton', 'Brighton & Hove Albion')
var_details1$team1 <- sub_value_df(var_details1$team1,'Leicester', 'Leicester City')
var_details1$team1 <- sub_value_df(var_details1$team1,'Man City', 'Manchester City')
var_details1$team1 <- sub_value_df(var_details1$team1,'Man United', 'Manchester United')
var_details1$team1 <- sub_value_df(var_details1$team1,'Norwich', 'Norwich City')
var_details1$team1 <- sub_value_df(var_details1$team1,'Tottenham', 'Tottenham Hotspur')
var_details1$team1 <- sub_value_df(var_details1$team1,'WBA', 'West Brom')

#seguimos con los nombres de los equipos visitantes
var_details$team2 <- as.character(var_details$team2)
var_details1$team2 <- as.character(var_details1$team2)

var_details$team2 <- sub_value_df(var_details$team2,'Leicester','Leicester City')
var_details$team2 <- sub_value_df(var_details$team2,'Man City', 'Manchester City')
var_details$team2 <- sub_value_df(var_details$team2,'Man United', 'Manchester United')
var_details$team2 <- sub_value_df(var_details$team2,'Newcastle', 'Newcastle United')
var_details$team2 <- sub_value_df(var_details$team2,'Norwich', 'Norwich City')
var_details$team2 <- sub_value_df(var_details$team2,'Tottenham', 'Tottenham Hotspur')
var_details$team2 <- sub_value_df(var_details$team2,'WBA', 'West Brom')
var_details1$team2 <- sub_value_df(var_details1$team2,'Leicester','Leicester City')
var_details1$team2 <- sub_value_df(var_details1$team2,'Man City', 'Manchester City')
var_details1$team2 <- sub_value_df(var_details1$team2,'Man United', 'Manchester United')
var_details1$team2 <- sub_value_df(var_details1$team2,'Newcastle', 'Newcastle United')
var_details1$team2 <- sub_value_df(var_details1$team2,'Norwich', 'Norwich City')
var_details1$team2 <- sub_value_df(var_details1$team2,'Tottenham', 'Tottenham Hotspur')

#vamos con el df de overturns
ovrt_var$team <- as.character(ovrt_var$team)

ovrt_var$team <- sub_value_df(ovrt_var$team,'Newcastle', 'Newcastle United')
ovrt_var$team <- sub_value_df(ovrt_var$team,'Norwich', 'Norwich City')

#vamos con el df de premier league
premier_league$team1 <- as.character(premier_league$team1)
premier_league$team2 <- as.character(premier_league$team2)

premier_league$team1 <- sub_value_df(premier_league$team1,'Leeds United','Leeds')
premier_league$team1 <- sub_value_df(premier_league$team1,'Newcastle', 'Newcastle United')
premier_league$team1 <- sub_value_df(premier_league$team1,'West Bromwich Albion', 'West Brom')
premier_league$team1 <- sub_value_df(premier_league$team1,'West Ham United', 'West Ham')
premier_league$team1 <- sub_value_df(premier_league$team1,'Wolverhampton', 'Wolves')
premier_league$team2 <- sub_value_df(premier_league$team2,'Leeds United','Leeds')
premier_league$team2 <- sub_value_df(premier_league$team2,'Newcastle', 'Newcastle United')
premier_league$team2 <- sub_value_df(premier_league$team2,'West Bromwich Albion', 'West Brom')
premier_league$team2 <- sub_value_df(premier_league$team2,'West Ham United', 'West Ham')
premier_league$team2 <- sub_value_df(premier_league$team2,'Wolverhampton', 'Wolves')

#les agregamos las variables de big_six
ovrt_df['big_six'] <- sapply(ovrt_df$team,is_big_six)
ovrt_var['big_six'] <- sapply(ovrt_var$team,is_big_six)
var_details['big_six_h'] <- sapply(var_details$team1, is_big_six)
var_details['big_six_a'] <- sapply(var_details$team2, is_big_six)
var_details['big_six'] <- if_else(var_details$big_six_h == 1 | var_details$big_six_a == 1,1,0)
var_details1['big_six_h'] <- sapply(var_details1$team1, is_big_six)
var_details1['big_six_a'] <- sapply(var_details1$team2, is_big_six)
var_details1['big_six'] <- if_else(var_details1$big_six_h == 1 | var_details1$big_six_a == 1,1,0)
```

Datos obtenidos de https://www.football-data.co.uk/englandm.php

```{r epl stats, include= FALSE}
#leemos la data
stats_1617 <- read.csv('/Users/pedrovela/Documents/Git_repos/var_epl/getting_data/stats_epl_1617.csv') 
stats_1718 <- read.csv('/Users/pedrovela/Documents/Git_repos/var_epl/getting_data/stats_epl_1718.csv') 
stats_1819 <- read.csv('/Users/pedrovela/Documents/Git_repos/var_epl/getting_data/stats_epl_1819.csv') 
stats_1920 <- read.csv('/Users/pedrovela/Documents/Git_repos/var_epl/getting_data/stats_epl_1920.csv') 
stats_2021 <- read.csv('/Users/pedrovela/Documents/Git_repos/var_epl/getting_data/stats_epl_2021.csv')
stats_2022 <- read.csv('/Users/pedrovela/Documents/Git_repos/var_epl/getting_data/stats_epl_2022.csv')

#quitamos la columna DIV
stats_1617 <- stats_1617[-c(1)]
stats_1718 <- stats_1718[-c(1)]
stats_1819 <- stats_1819[-c(1)]
stats_1920 <- stats_1920[-c(1)]
stats_2021 <- stats_2021[-c(1)]
stats_2022 <- stats_2022[-c(1)]

#agregamos la columna de season
stats_1617['season'] <- '16/17'
stats_1718['season'] <- '17/18'
stats_1819['season'] <- '18/19'
stats_1920['season'] <- '19/20'
stats_2021['season'] <- '20/21'
stats_2022['season'] <- '21/22'

#empezamos a unir las tablas
stats_epl <- merge(stats_1617,stats_1718,all = T) %>% merge(.,stats_1819,all = T) %>% merge(.,stats_1920,all = T) %>% merge(.,stats_2021,all=T) %>% merge(.,stats_2022,all=T)

#Nos quedamos solo con las columnas que nos interesan
stats_epl <- stats_epl[c('Date','Time','HomeTeam','AwayTeam','FTHG','FTAG','FTR','HTHG','HTAG','HTR','Referee','HS','AS','HST','AST','HC','AC','HF','AF','HY','AY','HR','AR','season')]

#Homologamos el nombre de los equipos con los demas dfs
stats_epl$HomeTeam <- as.character(stats_epl$HomeTeam)
stats_epl$AwayTeam <- as.character(stats_epl$AwayTeam)

#Reemplazamos los valores NA
stats_epl$HomeTeam[is.na(stats_epl$HomeTeam)] <- ""
stats_epl$AwayTeam[is.na(stats_epl$AwayTeam)] <- ""

#Sustituimos los nombres para homologar
stats_epl$HomeTeam <- sub_value_df(stats_epl$HomeTeam,'Bournemouth', 'AFC Bournemouth')
stats_epl$HomeTeam <- sub_value_df(stats_epl$HomeTeam,'Brighton', 'Brighton & Hove Albion')
stats_epl$HomeTeam <- sub_value_df(stats_epl$HomeTeam,'Leicester', 'Leicester City')
stats_epl$HomeTeam <- sub_value_df(stats_epl$HomeTeam,'Man City', 'Manchester City')
stats_epl$HomeTeam <- sub_value_df(stats_epl$HomeTeam,'Man United', 'Manchester United')
stats_epl$HomeTeam <- sub_value_df(stats_epl$HomeTeam,'Norwich', 'Norwich City')
stats_epl$HomeTeam <- sub_value_df(stats_epl$HomeTeam,'Tottenham', 'Tottenham Hotspur')
stats_epl$AwayTeam <- sub_value_df(stats_epl$AwayTeam,'Bournemouth', 'AFC Bournemouth')
stats_epl$AwayTeam <- sub_value_df(stats_epl$AwayTeam,'Brighton', 'Brighton & Hove Albion')
stats_epl$AwayTeam <- sub_value_df(stats_epl$AwayTeam,'Leicester', 'Leicester City')
stats_epl$AwayTeam <- sub_value_df(stats_epl$AwayTeam,'Man City', 'Manchester City')
stats_epl$AwayTeam <- sub_value_df(stats_epl$AwayTeam,'Man United', 'Manchester United')
stats_epl$AwayTeam <- sub_value_df(stats_epl$AwayTeam,'Norwich', 'Norwich City')
stats_epl$AwayTeam <- sub_value_df(stats_epl$AwayTeam,'Tottenham', 'Tottenham Hotspur')

#Agregamos el flag de big_six
stats_epl['big_six_h'] <- sapply(stats_epl$HomeTeam,is_big_six)
stats_epl['big_six_a'] <- sapply(stats_epl$AwayTeam,is_big_six)
stats_epl['big_six'] <- if_else(stats_epl$big_six_a == 1 | stats_epl$big_six_h == 1,1,0)
```

```{r cleaned merged seasons, include=FALSE}
#leemos la data
cleaned_merged_seasons <- read.csv('/Users/pedrovela/Documents/Git_repos/var_epl/getting_data/cleaned_merged_seasons.csv')

#eliminamos las columnas que no nos muestran dinamismo de equipo o jugador
cleaned_merged_seasons <- cleaned_merged_seasons[-c(1,19,11,12,27)]

#reenombramos algunas columnas
cleaned_merged_seasons <-  cleaned_merged_seasons %>% rename(season = season_x, team1 = team_x)

#Homologamos el nombre de los equipos con los demas dfs
cleaned_merged_seasons$team1 <- as.character(cleaned_merged_seasons$team1)
cleaned_merged_seasons$opp_team_name <- as.character(cleaned_merged_seasons$opp_team_name)

cleaned_merged_seasons$team1 <- sub_value_df(cleaned_merged_seasons$team1,'Brighton','Brighton & Hove Albion')
cleaned_merged_seasons$team1 <- sub_value_df(cleaned_merged_seasons$team1,'Leicester','Leicester City')
cleaned_merged_seasons$team1 <- sub_value_df(cleaned_merged_seasons$team1,'Man City','Manchester City')
cleaned_merged_seasons$team1 <- sub_value_df(cleaned_merged_seasons$team1,'Man Utd','Manchester United')
cleaned_merged_seasons$team1 <- sub_value_df(cleaned_merged_seasons$team1,'Norwich','Norwich City')
cleaned_merged_seasons$team1 <- sub_value_df(cleaned_merged_seasons$team1,'Sheffield Utd','Sheffield United')
cleaned_merged_seasons$team1 <- sub_value_df(cleaned_merged_seasons$team1,'Spurs','Tottenham Hotspur')

cleaned_merged_seasons$opp_team_name <- sub_value_df(cleaned_merged_seasons$opp_team_name,'Bournemouth','AFC Bournemouth')
cleaned_merged_seasons$opp_team_name <- sub_value_df(cleaned_merged_seasons$opp_team_name,'Brighton','Brighton & Hove Albion')
cleaned_merged_seasons$opp_team_name <- sub_value_df(cleaned_merged_seasons$opp_team_name,'Leicester','Leicester City')
cleaned_merged_seasons$opp_team_name <- sub_value_df(cleaned_merged_seasons$opp_team_name,'Man City','Manchester City')
cleaned_merged_seasons$opp_team_name <- sub_value_df(cleaned_merged_seasons$opp_team_name,'Man Utd','Manchester United')
cleaned_merged_seasons$opp_team_name <- sub_value_df(cleaned_merged_seasons$opp_team_name,'Norwich','Norwich City')
cleaned_merged_seasons$opp_team_name <- sub_value_df(cleaned_merged_seasons$opp_team_name,'Sheffield Utd','Sheffield United')
cleaned_merged_seasons$opp_team_name <- sub_value_df(cleaned_merged_seasons$opp_team_name,'Spurs','Tottenham Hotspur')

#Agregamos las columnas de big_six

#creamos columnas auxiliares nuevas para facilitar la lógica
cleaned_merged_seasons['bs_t'] <- sapply(cleaned_merged_seasons$team1, is_big_six)
cleaned_merged_seasons['bs_ot'] <- sapply(cleaned_merged_seasons$opp_team_name, is_big_six)

#aplicamos las reglas para big_six
cleaned_merged_seasons['big_six_h'] <- if_else((cleaned_merged_seasons$bs_t == 1 & cleaned_merged_seasons$was_home == 'True') | (cleaned_merged_seasons$bs_ot == 1 & cleaned_merged_seasons$was_home == 'False'),1,0)
cleaned_merged_seasons['big_six_a'] <- if_else((cleaned_merged_seasons$bs_t == 1 & cleaned_merged_seasons$was_home == 'False') | (cleaned_merged_seasons$bs_ot == 1 & cleaned_merged_seasons$was_home == 'True'),1,0)
cleaned_merged_seasons['big_six'] <- if_else(cleaned_merged_seasons$big_six_h == 1 | cleaned_merged_seasons$big_six_a == 1,1,0)

#eliminamos las columnas auxiliares
cleaned_merged_seasons <- cleaned_merged_seasons[-c(34,35)]

#-----------falta actualizacion 21/22
```

```{r fpl_merged_players}
#leemos la data
cleaned_players_1617 <- read.csv('/Users/pedrovela/Documents/Git_repos/var_epl/getting_data/cleaned_players_1617.csv')
cleaned_players_1718 <- read.csv('/Users/pedrovela/Documents/Git_repos/var_epl/getting_data/cleaned_players_1718.csv')
cleaned_players_1819 <- read.csv('/Users/pedrovela/Documents/Git_repos/var_epl/getting_data/cleaned_players_1819.csv')
cleaned_players_1920 <- read.csv('/Users/pedrovela/Documents/Git_repos/var_epl/getting_data/cleaned_players_1920.csv')
cleaned_players_2021 <- read.csv('/Users/pedrovela/Documents/Git_repos/var_epl/getting_data/cleaned_players_2021.csv')
cleaned_players_2022 <- read.csv('/Users/pedrovela/Documents/Git_repos/var_epl/getting_data/cleaned_players_2022.csv')

#le agregamos la columna de season
cleaned_players_1617['season'] <- '16/17'
cleaned_players_1718['season'] <- '17/18'
cleaned_players_1819['season'] <- '18/19'
cleaned_players_1920['season'] <- '19/20'
cleaned_players_2021['season'] <- '20/21'
cleaned_players_2022['season'] <- '21/22'

#unimos todos en uno solo
merged_cleaned_players <- cleaned_players_1617 %>% bind_rows(cleaned_players_1718) %>% bind_rows(cleaned_players_1819) %>% bind_rows(cleaned_players_1920) %>% bind_rows(cleaned_players_2021) %>% bind_rows(cleaned_players_2022)

merged_cleaned_players$second_name <- as.character(merged_cleaned_players$second_name)
merged_cleaned_players$first_name <- as.character(merged_cleaned_players$first_name)

merged_cleaned_players$second_name <- sapply(merged_cleaned_players$second_name,gsub,pattern="<e9>",replacement="é")
merged_cleaned_players$second_name <- sapply(merged_cleaned_players$second_name,gsub,pattern="<e1>",replacement="á")
merged_cleaned_players$second_name <- sapply(merged_cleaned_players$second_name,gsub,pattern="<e8>",replacement="e")
merged_cleaned_players$second_name <- sapply(merged_cleaned_players$second_name,gsub,pattern="<fa>",replacement="ú")
merged_cleaned_players$second_name <- sapply(merged_cleaned_players$second_name,gsub,pattern="<f1>",replacement="n")
merged_cleaned_players$second_name <- sapply(merged_cleaned_players$second_name,gsub,pattern="<f3>",replacement="ó")
merged_cleaned_players$second_name <- sapply(merged_cleaned_players$second_name,gsub,pattern="<e0>",replacement="á")
merged_cleaned_players$second_name <- sapply(merged_cleaned_players$second_name,gsub,pattern="<ed>",replacement="í")
merged_cleaned_players$second_name <- sapply(merged_cleaned_players$second_name,gsub,pattern="<eb>",replacement="e")
merged_cleaned_players$second_name <- sapply(merged_cleaned_players$second_name,gsub,pattern="<f6>",replacement="o")
merged_cleaned_players$second_name <- sapply(merged_cleaned_players$second_name,gsub,pattern="<fc>",replacement="u")
merged_cleaned_players$second_name <- sapply(merged_cleaned_players$second_name,gsub,pattern="<ef>",replacement="i")
merged_cleaned_players$second_name <- sapply(merged_cleaned_players$second_name,gsub,pattern="<d6>",replacement="O")
merged_cleaned_players$second_name <- sapply(merged_cleaned_players$second_name,gsub,pattern="<f8>",replacement="o")
merged_cleaned_players$second_name <- sapply(merged_cleaned_players$second_name,gsub,pattern="<f5>",replacement="o")
merged_cleaned_players$second_name <- sapply(merged_cleaned_players$second_name,gsub,pattern="<e5>",replacement="a")
merged_cleaned_players$second_name <- sapply(merged_cleaned_players$second_name,gsub,pattern="<c1>",replacement="Á")
merged_cleaned_players$second_name <- sapply(merged_cleaned_players$second_name,gsub,pattern="<e4>",replacement="a")

merged_cleaned_players$first_name <- sapply(merged_cleaned_players$first_name,gsub,pattern="<e9>",replacement="é")
merged_cleaned_players$first_name <- sapply(merged_cleaned_players$first_name,gsub,pattern="<e1>",replacement="á")
merged_cleaned_players$first_name <- sapply(merged_cleaned_players$first_name,gsub,pattern="<e8>",replacement="e")
merged_cleaned_players$first_name <- sapply(merged_cleaned_players$first_name,gsub,pattern="<fa>",replacement="ú")
merged_cleaned_players$first_name <- sapply(merged_cleaned_players$first_name,gsub,pattern="<f1>",replacement="n")
merged_cleaned_players$first_name <- sapply(merged_cleaned_players$first_name,gsub,pattern="<f3>",replacement="ó")
merged_cleaned_players$first_name <- sapply(merged_cleaned_players$first_name,gsub,pattern="<e0>",replacement="á")
merged_cleaned_players$first_name <- sapply(merged_cleaned_players$first_name,gsub,pattern="<ed>",replacement="í")
merged_cleaned_players$first_name <- sapply(merged_cleaned_players$first_name,gsub,pattern="<eb>",replacement="e")
merged_cleaned_players$first_name <- sapply(merged_cleaned_players$first_name,gsub,pattern="<f6>",replacement="o")
merged_cleaned_players$first_name <- sapply(merged_cleaned_players$first_name,gsub,pattern="<fc>",replacement="u")
merged_cleaned_players$first_name <- sapply(merged_cleaned_players$first_name,gsub,pattern="<ef>",replacement="i")
merged_cleaned_players$first_name <- sapply(merged_cleaned_players$first_name,gsub,pattern="<d6>",replacement="O")
merged_cleaned_players$first_name <- sapply(merged_cleaned_players$first_name,gsub,pattern="<f8>",replacement="o")
merged_cleaned_players$first_name <- sapply(merged_cleaned_players$first_name,gsub,pattern="<f5>",replacement="o")
merged_cleaned_players$first_name <- sapply(merged_cleaned_players$first_name,gsub,pattern="<e5>",replacement="a")
merged_cleaned_players$first_name <- sapply(merged_cleaned_players$first_name,gsub,pattern="<c1>",replacement="Á")
merged_cleaned_players$first_name <- sapply(merged_cleaned_players$first_name,gsub,pattern="<e4>",replacement="a")
```

```{r merged_gw_formatted}
#leemos la data
merged_gw_1617 <- read.csv('/Users/pedrovela/Documents/Git_repos/var_epl/getting_data/merged_gw_1617.csv')
merged_gw_1718 <- read.csv('/Users/pedrovela/Documents/Git_repos/var_epl/getting_data/merged_gw_1718.csv')
merged_gw_1819 <- read.csv('/Users/pedrovela/Documents/Git_repos/var_epl/getting_data/merged_gw_1819.csv')
merged_gw_1920 <- read.csv('/Users/pedrovela/Documents/Git_repos/var_epl/getting_data/merged_gw_1920.csv')
merged_gw_2021 <- read.csv('/Users/pedrovela/Documents/Git_repos/var_epl/getting_data/merged_gw_2021.csv')
merged_gw_2022 <- read.csv('/Users/pedrovela/Documents/Git_repos/var_epl/getting_data/merged_gw_2022.csv')

#le creamos la columna season
merged_gw_1617['season'] <- '16/17'
merged_gw_1718['season'] <- '17/18'
merged_gw_1819['season'] <- '18/19'
merged_gw_1920['season'] <- '19/20'
merged_gw_2021['season'] <- '20/21'
merged_gw_2022['season'] <- '21/22'

#unimos la data
merged_gw <- merged_gw_1617 %>% bind_rows(merged_gw_1718) %>% bind_rows(merged_gw_1819) %>% bind_rows(merged_gw_1920) %>% bind_rows(merged_gw_2021) %>% bind_rows(merged_gw_2022)

#eliminamos columnas
merged_gw <- merged_gw %>% select(.,-c('ea_index','element','fixture','id','kickoff_time_formatted','round','selected','value'))

#empezamos proceso de la limpieza de la data

#corregimos nombres: quitarle guión bajo y acentos 
merged_gw$name <- as.character(merged_gw$name)
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="_",replacement=" ")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<e9>",replacement="é")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<e1>",replacement="á")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<e8>",replacement="e")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<fa>",replacement="ú")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<f1>",replacement="n")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<f3>",replacement="ó")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<e0>",replacement="á")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<ed>",replacement="í")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<eb>",replacement="e")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<f6>",replacement="o")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<fc>",replacement="u")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<ef>",replacement="i")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<d6>",replacement="O")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<f8>",replacement="o")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<f5>",replacement="o")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<e5>",replacement="a")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<c1>",replacement="Á")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<e4>",replacement="a")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<e3>",replacement="a")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<df>",replacement="ss")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<e7>",replacement="c")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<c7>",replacement="c")

#leemos el archivo con los códigos para los equips en cada temporada
teams_list <- read.csv('/Users/pedrovela/Documents/Git_repos/var_epl/getting_data/master_team_list.csv')
teams_list$season <- sapply(teams_list$season,as.character) %>% sapply(.,substr,3,length(.)) %>% sapply(.,gsub,pattern="-",replacement="/")
teams_list$team_name <- sapply(teams_list$team_name,as.character) 

#juntamos ambas tablas para definir el nombre del equipo contrario
merged_gw_formatted <- merged_gw %>% left_join(teams_list,by=c('season','opponent_team' = 'team'))
#eliminamos la columna donde viene el código del equipo y reenombramos la nueva columna con el nombre completo
merged_gw_formatted <- merged_gw_formatted %>% select(.,-c('opponent_team')) %>% rename(opponent_team = team_name)

#Homologamos el nombre de los equipos con los demas dfs
merged_gw_formatted$team <- as.character(merged_gw_formatted$team)
merged_gw_formatted$opponent_team <- as.character(merged_gw_formatted$opponent_team)
merged_gw_formatted$team[is.na(merged_gw_formatted$team)] <- ""
merged_gw_formatted$opponent_team[is.na(merged_gw_formatted$opponent_team)] <- ""

merged_gw_formatted$team <- sub_value_df(merged_gw_formatted$team,'Brighton','Brighton & Hove Albion')
merged_gw_formatted$team <- sub_value_df(merged_gw_formatted$team,'Leicester','Leicester City')
merged_gw_formatted$team <- sub_value_df(merged_gw_formatted$team,'Man City','Manchester City')
merged_gw_formatted$team <- sub_value_df(merged_gw_formatted$team,'Man Utd','Manchester United')
merged_gw_formatted$team <- sub_value_df(merged_gw_formatted$team,'Norwich','Norwich City')
merged_gw_formatted$team <- sub_value_df(merged_gw_formatted$team,'Sheffield Utd','Sheffield United')
merged_gw_formatted$team <- sub_value_df(merged_gw_formatted$team,'Spurs','Tottenham Hotspur')

merged_gw_formatted$opponent_team <- sub_value_df(merged_gw_formatted$opponent_team,'Bournemouth','AFC Bournemouth')
merged_gw_formatted$opponent_team <- sub_value_df(merged_gw_formatted$opponent_team,'Brighton','Brighton & Hove Albion')
merged_gw_formatted$opponent_team <- sub_value_df(merged_gw_formatted$opponent_team,'Leicester','Leicester City')
merged_gw_formatted$opponent_team <- sub_value_df(merged_gw_formatted$opponent_team,'Man City','Manchester City')
merged_gw_formatted$opponent_team <- sub_value_df(merged_gw_formatted$opponent_team,'Man Utd','Manchester United')
merged_gw_formatted$opponent_team <- sub_value_df(merged_gw_formatted$opponent_team,'Norwich','Norwich City')
merged_gw_formatted$opponent_team <- sub_value_df(merged_gw_formatted$opponent_team,'Sheffield Utd','Sheffield United')
merged_gw_formatted$opponent_team <- sub_value_df(merged_gw_formatted$opponent_team,'Spurs','Tottenham Hotspur')

#Agregamos el flag de big six

#Creamos columnas auxiliares nuevas para hacer más fácil la comparación
merged_gw_formatted['bs_t'] <- sapply(merged_gw_formatted$team, is_big_six)
merged_gw_formatted['bs_ot'] <- sapply(merged_gw_formatted$opponent_team, is_big_six)

#aplicamos las reglas para big_six
merged_gw_formatted['big_six_h'] <- if_else((merged_gw_formatted$bs_t == 1 & merged_gw_formatted$was_home == 'True') | (merged_gw_formatted$bs_ot == 1 & merged_gw_formatted$was_home == 'False'),1,0)
merged_gw_formatted['big_six_a'] <- if_else((merged_gw_formatted$bs_t == 1 & merged_gw_formatted$was_home == 'False') | (merged_gw_formatted$bs_ot == 1 & merged_gw_formatted$was_home == 'True'),1,0)
merged_gw_formatted['big_six'] <- if_else(merged_gw_formatted$big_six_h == 1 | merged_gw_formatted$big_six_a == 1,1,0)

#eliminamos las columnas auxiliares
merged_gw_formatted <- merged_gw_formatted[-c(53,54)]
```

```{r,include=FALSE}
#Escribimos las tablas en archivos csv para no perderlos
#write_csv(premier_league,"/Users/pedrovela/Documents/Git_repos/var_epl/tables/premier_league.csv")
#write_csv(ovrt_df,"/Users/pedrovela/Documents/Git_repos/var_epl/tables/pl_overturns.csv")
#write_csv(ovrt_var,"/Users/pedrovela/Documents/Git_repos/var_epl/tables/pl_overturns_var.csv")
#write_csv(var_details,"/Users/pedrovela/Documents/Git_repos/var_epl/tables/var_details.csv")
#write_csv(var_details1,"/Users/pedrovela/Documents/Git_repos/var_epl/tables/var_details1.csv")
#write_csv(stats_epl,"/Users/pedrovela/Documents/Git_repos/var_epl/tables/stats_epl.csv")
#write_csv(cleaned_merged_seasons,"/Users/pedrovela/Documents/Git_repos/var_epl/tables/fpl_merged_seasons.csv")
#write_csv(merged_cleaned_players,"/Users/pedrovela/Documents/Git_repos/var_epl/tables/fpl_merged_players.csv")
#write_csv(merged_gw_formatted,"/Users/pedrovela/Documents/Git_repos/var_epl/tables/fpl_merged_gw.csv")
```

De aquí ya tenemos datos acerca de 1900 partidos de la PL desde 2016, de aquí podemos empezar a hacer análisis exploratorio.

**Tal vez agregar al campeón de cada temporada, nos podría servir como indicador de algo en cuanto a métricas**

