---
title: "Getting PL data (2016-present)"
author: "Pedro Alan Velázquez Romero"
date: "5/3/2021"
output: html_document
params:
  is_work_computer: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, include = FALSE}
#librerias a utilizar 
#install.packages(c("dplyr","ggplot2","tidyr","httr","XML","rvest","xml2","tidyverse","robotstxt",
            #       "urltools","git2r"))
library(dplyr)
library(ggplot2)
library(tidyr)
library(httr)
library(XML)
library(rvest)
library(xml2)
library(tidyverse)
library(robotstxt)
library(urltools)
library(methods)
library(git2r)
```

```{r load_scripts,include=FALSE}
#script en donde incluimos las funciones globales (del ambiente)
source("functions_scripts/general_functions.R", local = knitr::knit_global())
#script en donde leemos la data de FiveThirtyEight
source("functions_scripts/df_premier_league.R", local = knitr::knit_global())
#script en donde incluimos las funciones referentes a la tabla pl_overturns
source("functions_scripts/df_pl_overturns.R", local = knitr::knit_global())
#script en donde incluimos las funciones referentes a la tabla pl_stats
source("functions_scripts/df_pl_stats.R", local = knitr::knit_global())
#script en donde incluimos las funciones referentes a la tabla cleaned_merged_seasons
source("functions_scripts/df_cleaned_merged_seasons.R", local = knitr::knit_global())
#script en donde incluimos las funciones referentes a la tabla cleaned_merged_players
source("functions_scripts/df_merged_players.R", local = knitr::knit_global())
#script en donde incluimos las funciones referentes a la tabla cleaned_merged_gw
source("functions_scripts/df_merged_gw.R", local = knitr::knit_global())
#script en donde incluimos las funciones referentes a la tabla poss_stats
source("functions_scripts/df_poss_stats.R", local = knitr::knit_global())
#script en donde incluimos las funciones referentes a la tabla action_zones
source("functions_scripts/df_action_zones.R", local = knitr::knit_global())
```

```{r local_vars,include=FALSE}
#Agregamos las variables locales

#Ruta del repo en general de FPL
ruta_fpl_repo <- get_fpl_repo_directory()
#Lista con credenciales de Git
my_git_credentials <- my_git_credentials()
#ruta para el folder con la data raw de FPL
ruta_fpl <- get_fpl_directory()
#Nombre de los archivos que se actualizaron y se deben enviar a la carpeta del repo propio
files_names <- c('cleaned_merged_seasons.csv',
                 '2016-17/gws/merged_gw.csv','2016-17/cleaned_players.csv','2016-17/players_raw.csv',
                 '2017-18/gws/merged_gw.csv','2017-18/cleaned_players.csv','2017-18/players_raw.csv',
                 '2018-19/gws/merged_gw.csv','2018-19/cleaned_players.csv','2018-19/players_raw.csv',
                 '2019-20/gws/merged_gw.csv','2019-20/cleaned_players.csv','2019-20/players_raw.csv',
                 '2020-21/gws/merged_gw.csv','2020-21/cleaned_players.csv','2020-21/players_raw.csv',
                 '2021-22/gws/merged_gw.csv','2021-22/cleaned_players.csv','2021-22/players_raw.csv')
#Nombre de los archivos con los que se guardarán en el folder del repo propio
nombres_finales <- c('cleaned_merged_seasons.csv',
                     'merged_gw_1617.csv','cleaned_players_1617.csv','players_raw_1617.csv',
                     'merged_gw_1718.csv','cleaned_players_1718.csv','players_raw_1718.csv',
                     'merged_gw_1819.csv','cleaned_players_1819.csv','players_raw_1819.csv',
                     'merged_gw_1920.csv','cleaned_players_1920.csv','players_raw_1920.csv',
                     'merged_gw_2021.csv','cleaned_players_2021.csv','players_raw_2021.csv',
                     'merged_gw_2122.csv','cleaned_players_2122.csv','players_raw_2122.csv')
#ruta para guardar tablas finales
ruta_guardado <- get_tables_directory(params$is_work_computer)
#ruta para leer data raw
ruta_raw <- get_raw_directory(params$is_work_computer)
#catalogo de jugadores y equipos por temporada
players_teams_catalog_1617 <- get_players_catalog(ruta_raw,'16/17')
players_teams_catalog_1718 <- get_players_catalog(ruta_raw,'17/18')
players_teams_catalog_1819 <- get_players_catalog(ruta_raw,'18/19')
players_teams_catalog_1920 <- get_players_catalog(ruta_raw,'19/20')
players_teams_catalog_2021 <- get_players_catalog(ruta_raw,'20/21')
players_teams_catalog_2122 <- get_players_catalog(ruta_raw,'21/22')
#Unimos los catálogos de cada temporada en uno solo
players_teams_catalog <- players_teams_catalog_1617 %>% bind_rows(players_teams_catalog_1718) %>% bind_rows(players_teams_catalog_1819) %>% bind_rows(players_teams_catalog_1920) %>% bind_rows(players_teams_catalog_2021) %>% bind_rows(players_teams_catalog_2122)
```

```{r update_fpl_data,include=FALSE}
#En esta parte actualizamos la data proveniente del repo de GitHub de la FPL

#Actualizamos la data vía Git
pull(repo = ruta_fpl_repo,
     credentials = cred_user_pass(username = my_git_credentials$username,
                                  password = my_git_credentials$pw))

#Una vez que ya tenemos los archivos actualizados vía el Git, los subimos a sus respectivas carpetas del repo propio
load_raw_csv(ruta_fpl,files_names,ruta_raw,nombres_finales)
```

# Tablas de información acerca de la PL

Dentro de este script lo que se pretende lograr es transformar la data raw que se obtuvo acerca de la liga Premier de Inglaterra, el resultado final que buscamos es generar las tablas finales con las variables pertinentes.

## Tabla 1: "premier_league". Fuente: FiveThirtyEight

La primera data de información se obtiene de la página [FiveThirtyEight](https://projects.fivethirtyeight.com/soccer-predictions/premier-league/), la cual, a grandes rasgos, se dedica a aplicar métodos estadísticos de análisis y predicción sobre datos deportivos (y algunos que otros de interés general). Gracias a ello es que pude obtener el conjunto de datos acerca de algunas estadísticas de los partidos jugados en la liga profesional de fútbol inglesa, la Premier League (PL), entre algunas de las estadísticas que se logran obtener de este conjunto de datos son las siguientes:

* prob1: Probabilidad de victoria que se le otorga al equipo local durante un partido en específico

* xg1: Goles esperados del equipo local durante un partido en específico

* spi1: Soccer Power Index del equipo local durante un partido en específico

Los datos aquí recolectados datan desde la temporada 2016/2017 hasta el día de hoy. Para información más detallada de las variables que se presentan en esta tabla se puede consultar el repositorio de [GitHub](https://github.com/pedro-vr/var_epl/tree/main/tables/dictionaries).

```{r premier_league_fivethirtyeight data,include=FALSE}
#Empezamos el proceso de leer la data de FiveThirtyEight

#Declaramos la url de donde se extrae toda la información directa de fivethirtyeight
url <- "https://projects.fivethirtyeight.com/soccer-api/club/spi_matches.csv"
#Llamamos a la función que lee el archivo a partir de la URL
football_matches <- read_538_data(url)
#Después de leer toda la data nos quedamos solamente con aquella de la PL
premier_league <- football_matches %>% filter((league == "Barclays Premier League") | (league_id == 2411))
#Eliminamos la variable con los datos de todos los torneos de fútbol
rm(football_matches)

#Empezamos proceso de creación de nuevas variables sobre la tabla premier_league

#Creamos otra variable para determinar en qué momento inició COVID
premier_league <- premier_league %>% mutate(after_covid = if_else(as.POSIXct(date) > as.POSIXct('2020-03-13'),1,0))
#Creamos la variable que nos indica si en el partido estuvo presente el VAR
premier_league <- premier_league %>% mutate(is_VAR = if_else(as.POSIXct(date) > as.POSIXct('2019-08-08'),1,0))
#Convertimos las variables de los nombres de los equipos a string
premier_league$team1 <- sapply(premier_league$team1,as.character)
premier_league$team2 <- sapply(premier_league$team2,as.character)
#Creamos la variable en donde nos dice si el equipo local es del big six
premier_league['big_six_h'] <- sapply(premier_league$team1, is_big_six)
#Creamos la variable en donde nos dice si el equipo visitante es del big six
premier_league['big_six_a'] <- sapply(premier_league$team2, is_big_six)
#Creamos la variable en donde nos dice si el equipo local o visitante (cualquiera de los dos) es del big six
premier_league <- premier_league %>% mutate(big_six = if_else(big_six_h == 1 | big_six_a == 1,1,0))
#Modificamos la variable season para tener un estándar de esa variable en todas las tablas
premier_league$season <- sapply(premier_league$season,as.character)
premier_league$season <- sapply(premier_league$season,season_format)
#Modificamos las columnas "team1" y "team2" para homologar el nombre de los equipos
#Convertimos las columnas a tipo character
premier_league$team1 <- as.character(premier_league$team1)
premier_league$team2 <- as.character(premier_league$team2)
#Aplicamos la función de sustitución de nombres a valores específicos 
premier_league$team1 <- sub_value_df(premier_league$team1,'Leeds United','Leeds')
premier_league$team1 <- sub_value_df(premier_league$team1,'Newcastle', 'Newcastle United')
premier_league$team1 <- sub_value_df(premier_league$team1,'West Bromwich Albion', 'West Brom')
premier_league$team1 <- sub_value_df(premier_league$team1,'West Ham United', 'West Ham')
premier_league$team1 <- sub_value_df(premier_league$team1,'Wolverhampton', 'Wolves')
premier_league$team2 <- sub_value_df(premier_league$team2,'Leeds United','Leeds')
premier_league$team2 <- sub_value_df(premier_league$team2,'Newcastle', 'Newcastle United')
premier_league$team2 <- sub_value_df(premier_league$team2,'West Bromwich Albion', 'West Brom')
premier_league$team2 <- sub_value_df(premier_league$team2,'West Ham United', 'West Ham')
premier_league$team2 <- sub_value_df(premier_league$team2,'Wolverhampton', 'Wolves')

#Ya que tenemos todas las variables necesarias y los datos transformados, guardamos la tabla en 
#el directorio local

#declaramos la ruta final de la tabla
ruta_final_pl <- paste(ruta_guardado,'premier_league.csv',sep = "")
#lo escribimos
write_csv(premier_league,ruta_final_pl)
```

Una vista general de algunos registros de esta tabla es la siguiente:

```{r premier_league_view}
head(premier_league)
```

## Tabla 2: "pl_overturns". Fuente: ESPN

La segunda tabla de información se obtiene de la página web de ESPN en donde se detallan con métricas las decisiones que ha tenido el VAR para con cada equipo de la PL durante todas las temporadas que ha estado en activo el VAR en dicha liga de fútbol. Las ligas de estas páginas web por año son las siguientes:

* [2019/20](https://www.espn.com/soccer/english-premier-league/story/3929823/how-var-decisions-have-affected-every-premier-league-club) 

* [2020/21](https://www.espn.com/soccer/english-premier-league/story/4182135/how-var-decisions-affected-every-premier-league-club-in-2020-21)

* [2021/22](https://www.espn.com/soccer/english-premier-league/story/4452736/how-var-decisions-have-affected-every-premier-league-club-in-2021-22)

Dentro de cada página web se detalla brevemente el balance que tuvo cada equipo de la PL en cuanto a decisiones a favor y en contra que tomó el VAR para con ellos dentro de cada temporada, algunos de ellos salen con saldos negativos y otros con saldos positivos. Las métricas que se detallan dentro de esta tabla son las siguientes:

1. Net Score (ns): Saldo total del número de decisiones a favor menos el número de decisiones en contra que tuvo el VAR para con cada equipo en una temporada determinda (df - da)

2. Decisions For (df): Número total de decisiones a favor que tuvo el VAR para con cada equipo en una temporada determinada

3. Decisions Against (da): Número total de decisiones en contra que tuvo el VAR para con cada equipo en una temporada determinada

Los datos aquí recolectados datan desde la temporada 2019/2020 hasta el día de hoy, esto debido a que el VAR se implementó por primera vez en el fútbol profesional de Inglaterra en el año 2019. Para información más detallada de las variables que se presentan en esta tabla se puede consultar el repositorio de [GitHub](https://github.com/pedro-vr/var_epl/tree/main/tables/dictionaries).

```{r ovrt_df,include=FALSE}
#Empezamos el proceso para obtener los datos de las intervenciones del VAR dentro de la PL (solo se tiene data a partir de la temporada 19/20)

#Obtenemos el df de overturns para la temporada 19/20
ovrt_df_19_20 <- get_pl_overturns(ruta_raw,'19/20')
#Obtenemos el df de overturns para la temporada 20/21
ovrt_df_20_21 <- get_pl_overturns(ruta_raw,'20/21')
#Obtenemos el df de overturns para la temporada 21/22
ovrt_df_21_22 <- get_pl_overturns(ruta_raw,'21/22',T)

#Unimos las tablas de cada temporada
ovrt_df <- ovrt_df_19_20 %>% bind_rows(ovrt_df_20_21) %>% bind_rows(ovrt_df_21_22)

#Agregamos la variable big_six a la tabla final
ovrt_df['big_six'] <- sapply(ovrt_df$team,is_big_six)

#Escribimos la tabla final a la carpeta local

#declaramos la ruta final de la tabla
ruta_final_pl_ovrt <- paste(ruta_guardado,'pl_overturns.csv',sep = "")
#lo escribimos
write_csv(ovrt_df,ruta_final_pl_ovrt)
```

Una vista general de algunos registros de esta tabla es la siguiente:

```{r ovrt_df_view}
head(ovrt_df)
```

## Tabla 3: "pl_overturns_var". Fuente: ESPN

La tercera tabla que se presenta aquí, al igual que la segunda, se obtiene de la página web de ESPN en donde se detallan las métricas relacionadas a las decisiones que toma el VAR ante diferentes eventos que se van suscitando dentro de cada partido de la PL. Las ligas de estas páginas web por año son las siguientes:

* [2019/20](https://www.espn.com/soccer/english-premier-league/story/3929823/how-var-decisions-have-affected-every-premier-league-club) 

* [2020/21](https://www.espn.com/soccer/english-premier-league/story/4182135/how-var-decisions-affected-every-premier-league-club-in-2020-21)

* [2021/22](https://www.espn.com/soccer/english-premier-league/story/4452736/how-var-decisions-have-affected-every-premier-league-club-in-2021-22)

Dentro de cada página web se detalla brevemente el balance que tuvo cada equipo de la PL en cuanto a decisiones a favor y en contra que tomó el VAR para con ellos dentro de cada temporada, algunos de ellos salen con saldos negativos y otros con saldos positivos. La diferencia de esta tabla con la número 2 es que en esta tabla se detallan más métricas relacionadas a decisiones del VAR. Algunas de esas métricas que se detallan dentro de esta tabla son las siguientes:

1. dga (disallowed goals against): Número total de goles anulados en contra del equipo en cuestión.

2. sdf (subjective decisions for): Número total de decisiones subjetivas del VAR a favor del equipo en cuestión

3. pns (penalties net score): Marcador neto de los penales tomados por cada equipo durante la temporada correspondiente de la EPL. Se considera la siguiente operación: (penalties a favor) - (penalties en contra), lo cual quiere decir, a su vez, que si el valor de esta variable es negativo, entonces el equipo tuvo más penalties marcado en contra que a favor; si el valor de esta variable es positiva, quiere decir que el equipo tuvo más penalties marcados a favor que en contra. Si el equipo correspondiente no cuenta con esta métrica para determinada temporada entonces se le asigna el valor "2019" por default.

Los datos aquí recolectados datan desde la temporada 2019/2020 hasta el día de hoy, esto debido a que el VAR se implementó por primera vez en el fútbol profesional de Inglaterra en el año 2019. Para información más detallada de las variables que se presentan en esta tabla se puede consultar el repositorio de [GitHub](https://github.com/pedro-vr/var_epl/tree/main/tables/dictionaries).

```{r ovrt_var,include=FALSE}
#Obtenemos la tabla con las métricas de los overturns para la temporada indicada
des_df_19_20 <- get_pl_overturns_desc(ruta_raw,'19/20')
des_df_20_21 <- get_pl_overturns_desc(ruta_raw,'20/21')
des_df_21_22 <- get_pl_overturns_desc(ruta_raw,'21/22',T)

#Unificamos los dfs de cada temporada
des_df <- des_df_19_20 %>% bind_rows(des_df_20_21) %>% bind_rows(des_df_21_22)

#ya que tenemos la tabla creada la unimos con la primera que obtuvimos atrás para ampliar las métricas
#Tabla que contiene las métricas en cuanto overturns por equipo 
ovrt_var <- inner_join(ovrt_df,des_df,by=c("season","team"))

#Modificamos la columna "team" para homologar el nombre de los equipos en todas las tablas
#Convetimos la columna a tipo character
ovrt_var$team <- as.character(ovrt_var$team)
#Hacemos la sustitución de los nombres
ovrt_var$team <- sub_value_df(ovrt_var$team,'Newcastle', 'Newcastle United')
ovrt_var$team <- sub_value_df(ovrt_var$team,'Norwich', 'Norwich City')
#Agregamos la columna big_six
ovrt_var['big_six'] <- sapply(ovrt_var$team,is_big_six)

#Escribimos la tabla final a la carpeta local

#declaramos la ruta final de la tabla
ruta_final_pl_ovrt_desc <- paste(ruta_guardado,'pl_overturns_var.csv',sep = "")
#lo escribimos
write_csv(ovrt_var,ruta_final_pl_ovrt_desc)
```

Una vista general de algunos registros de esta tabla es la siguiente:

```{r ovrt_var_view}
head(ovrt_var)
```

## Tabla 4: "var_details". Fuente: ESPN

La cuarta tabla que se presenta aquí, al igual que la segunda y la tercera, se obtiene de la página web de ESPN en donde se detallan los eventos en que el VAR intervino directamente durante cada partido de la PL, estos detalles son por escrito y están a manera de descripción de cada uno. Las ligas de estas páginas web por año son las siguientes:

* [2019/20](https://www.espn.com/soccer/english-premier-league/story/3929823/how-var-decisions-have-affected-every-premier-league-club) 

* [2020/21](https://www.espn.com/soccer/english-premier-league/story/4182135/how-var-decisions-affected-every-premier-league-club-in-2020-21)

* [2021/22](https://www.espn.com/soccer/english-premier-league/story/4452736/how-var-decisions-have-affected-every-premier-league-club-in-2021-22)

Cabe recalcar que los datos que se presentan aquí son precisamente los eventos descritos detalladamente tal cual pasaron durante el partido y sobre la cual el VAR llegó a tomar una decisión. Algunas de las variables que se presentan aquí son las siguientes:

1. team1: Nombre del equipo 1, es quien recibe la indicación del VAR

2. incident: Descripción de la intervención que se llevó a cabo por el VAR

3. type: Flag que indica si la intervención del VAR fue a favor (FOR) o en contra (AGAINST) del equipo 1 (team1)

Los datos aquí recolectados datan desde la temporada 2019/2020 hasta el día de hoy, esto debido a que el VAR se implementó por primera vez en el fútbol profesional de Inglaterra en el año 2019. Para información más detallada de las variables que se presentan en esta tabla se puede consultar el repositorio de [GitHub](https://github.com/pedro-vr/var_epl/tree/main/tables/dictionaries).

```{r var_details,include=FALSE}
#Empezamos con el proceso para obtener los detalles del VAR en ciertos partidos para cada equipo
#de la PL durante las dos temporadas

#Obtenemos la tabla para cada temporada
var_details_19_20 <- get_pl_var_details(ruta_raw,"19/20")
var_details_20_21 <- get_pl_var_details(ruta_raw,"20/21")
var_details_21_22 <- get_pl_var_details(ruta_raw,"21/22",T)

#Unimos las tablas para tener una sola consolidada
var_details <- var_details_19_20 %>% bind_rows(var_details_20_21) %>% bind_rows(var_details_21_22)

#Modificamos las columnas "team1" y "team2" para homologar el nombre de los equipos en todas las tablas
#Convertimos las columnas a tipo character
var_details$team1 <- as.character(var_details$team1)
var_details$team2 <- as.character(var_details$team2)
#Hacemos la sustitución en valores puntuales de las columnas
var_details$team1 <- sub_value_df(var_details$team1,'Norwich','Norwich City')
var_details$team2 <- sub_value_df(var_details$team2,'Leicester','Leicester City')
var_details$team2 <- sub_value_df(var_details$team2,'Man City', 'Manchester City')
var_details$team2 <- sub_value_df(var_details$team2,'Man United', 'Manchester United')
var_details$team2 <- sub_value_df(var_details$team2,'Newcastle', 'Newcastle United')
var_details$team2 <- sub_value_df(var_details$team2,'Norwich', 'Norwich City')
var_details$team2 <- sub_value_df(var_details$team2,'Tottenham', 'Tottenham Hotspur')
var_details$team2 <- sub_value_df(var_details$team2,'WBA', 'West Brom')
#Agregamos las variables correspondientes a los equipos big_six
var_details['big_six_h'] <- sapply(var_details$team1, is_big_six)
var_details['big_six_a'] <- sapply(var_details$team2, is_big_six)
var_details['big_six'] <- if_else(var_details$big_six_h == 1 | var_details$big_six_a == 1,1,0)

#Escribimos la tabla final a la carpeta local

#declaramos la ruta final de la tabla
ruta_final_pl_var_details <- paste(ruta_guardado,'var_details.csv',sep = "")
#lo escribimos
write_csv(var_details,ruta_final_pl_var_details)
```

Una vista general de algunos registros de esta tabla es la siguiente:

```{r var_details_view}
head(var_details)
```

## Tabla 5: "var_details1". Fuente: ESPN

La quinta tabla que se presenta aquí tiene la misma estructura que la tabla número 4, la diferencia es que es en esta tabla no se incluye la variable 'home.away', en su lugar, se manipularon los valores de algunas columnas para que así la columna "team1" ya incluya el nombre del equipo que fue verdaderamente local en el partido correspondiente de la PL, y por otro lado, la columna team2 representa el nombre del equipo que verdaderamente fue visitante durante el partido en cuestión. Todas las demás columnas y estructura de la tabla es la misma a la número 4.

```{r var_details1,include=FALSE}
#Empezamos el proceso para obtener la tabla con las descripciones de los incidentes analizados por el VAR

#Obtenemos las tablas finales con las descripciones de incidentes para cada temporada
var_details1_19_20 <- get_pl_var_details_2(ruta_raw,"19/20")
var_details1_20_21 <- get_pl_var_details_2(ruta_raw,"20/21")
var_details1_21_22 <- get_pl_var_details_2(ruta_raw,"21/22",T)

#Unimos todas las tablas en una sola consolidada
var_details1 <- var_details1_19_20 %>% bind_rows(var_details1_20_21) %>% bind_rows(var_details1_21_22)

#Empezamos con el proceso de modificar algunas columnas y agregar otras nuevas a la tabla final

#Modificamos la columna "team1" para homologar el nombre de los equipos entre tablas
#Convertimos las columnas a character
var_details1$team1 <- as.character(var_details1$team1)
var_details1$team2 <- as.character(var_details1$team2)
#Hacemos las modificaciones de los valores para la columna "team1" y "team2"
var_details1$team1 <- sub_value_df(var_details1$team1,'Bournemouth', 'AFC Bournemouth')
var_details1$team1 <- sub_value_df(var_details1$team1,'Brighton', 'Brighton & Hove Albion')
var_details1$team1 <- sub_value_df(var_details1$team1,'Leicester', 'Leicester City')
var_details1$team1 <- sub_value_df(var_details1$team1,'Man City', 'Manchester City')
var_details1$team1 <- sub_value_df(var_details1$team1,'Man United', 'Manchester United')
var_details1$team1 <- sub_value_df(var_details1$team1,'Norwich', 'Norwich City')
var_details1$team1 <- sub_value_df(var_details1$team1,'Tottenham', 'Tottenham Hotspur')
var_details1$team1 <- sub_value_df(var_details1$team1,'WBA', 'West Brom')
var_details1$team2 <- sub_value_df(var_details1$team2,'Leicester','Leicester City')
var_details1$team2 <- sub_value_df(var_details1$team2,'Man City', 'Manchester City')
var_details1$team2 <- sub_value_df(var_details1$team2,'Man United', 'Manchester United')
var_details1$team2 <- sub_value_df(var_details1$team2,'Newcastle', 'Newcastle United')
var_details1$team2 <- sub_value_df(var_details1$team2,'Norwich', 'Norwich City')
var_details1$team2 <- sub_value_df(var_details1$team2,'Tottenham', 'Tottenham Hotspur')
#Agregamos las variables relacionadas a los equipos big_six
var_details1['big_six_h'] <- sapply(var_details1$team1, is_big_six)
var_details1['big_six_a'] <- sapply(var_details1$team2, is_big_six)
var_details1['big_six'] <- if_else(var_details1$big_six_h == 1 | var_details1$big_six_a == 1,1,0)

#Escribimos la tabla final a la carpeta local

#declaramos la ruta final de la tabla
ruta_final_pl_var_details1 <- paste(ruta_guardado,'var_details1.csv',sep = "")
#lo escribimos
write_csv(var_details1,ruta_final_pl_var_details1)
```

Una vista general de algunos registros de esta tabla es la siguiente:

```{r var_details1_view}
head(var_details1)
```

## Tabla 6: "stats_epl". Fuente: Football-Data

La tabla número 6 que se presenta aquí muestra datos acerca de algunas estadísticas "comunes" que se dan durante cada partido de la PL, estas estadísticas están más orientadas a dar una descripción general de los principales eventos que se dan durante un partido de la PL, número de faltas cometidas por cada equipo, nuúmero de tiros a gol hechos por cada equipo, etc. Algunas de las variables que contiene la tabla son las siguientes:

1. FTHG (Full Time Home Team Goals): Número total de goles hechos por el equipo local durante todo el partido.

2. AS (Away Team Shots): Número total de tiros hechos por el equipo visitante durante todo el partido.

3. AF (Away Team Fouls Committed): Número total de faltas cometidas por el equipo visitante durante todo el partido.

Los datos fueron obtenidos de la página web [football-data](https://www.football-data.co.uk/englandm.php) y en esta tabla se presentan datos a partir de la temporada 2016/2017.

Para información más detallada de las variables que se presentan en esta tabla se puede consultar el repositorio de [GitHub](https://github.com/pedro-vr/var_epl/tree/main/tables/dictionaries).

```{r epl_stats, include= FALSE}
#Empezamos con el proceso para obtener la tabla con estadísticas generales de los partidos de la PL

#Leemos la tabla de estadísticas de cada partido de la PL en la temporada correspondiente
stats_1617 <- read_stats_data(ruta_raw,'16/17')
stats_1718 <- read_stats_data(ruta_raw,'17/18')
stats_1819 <- read_stats_data(ruta_raw,'18/19')
stats_1920 <- read_stats_data(ruta_raw,'19/20')
stats_2021 <- read_stats_data(ruta_raw,'20/21')
stats_2122 <- read_stats_data(ruta_raw,'21/22')

#Empezamos a unir las tablas en una sola consolidada
stats_epl <- merge(stats_1617,stats_1718,all = T) %>% merge(.,stats_1819,all = T) %>% merge(.,stats_1920,all = T) %>% merge(.,stats_2021,all=T) %>% merge(.,stats_2122,all=T)

#Nos quedamos solo con las columnas que nos interesan
stats_epl <- stats_epl[c('Date','Time','HomeTeam','AwayTeam','FTHG','FTAG','FTR','HTHG','HTAG','HTR','Referee','HS','AS','HST','AST','HC','AC','HF','AF','HY','AY','HR','AR','season')]

#Homologamos el nombre de los equipos con las demas tablas
stats_epl$HomeTeam <- as.character(stats_epl$HomeTeam)
stats_epl$AwayTeam <- as.character(stats_epl$AwayTeam)

#Reemplazamos los valores NA por valores vacíos
stats_epl$HomeTeam[is.na(stats_epl$HomeTeam)] <- ""
stats_epl$AwayTeam[is.na(stats_epl$AwayTeam)] <- ""

#Sustituimos los nombres para homologar
stats_epl$HomeTeam <- sub_value_df(stats_epl$HomeTeam,'Bournemouth', 'AFC Bournemouth')
stats_epl$HomeTeam <- sub_value_df(stats_epl$HomeTeam,'Brighton', 'Brighton & Hove Albion')
stats_epl$HomeTeam <- sub_value_df(stats_epl$HomeTeam,'Leicester', 'Leicester City')
stats_epl$HomeTeam <- sub_value_df(stats_epl$HomeTeam,'Man City', 'Manchester City')
stats_epl$HomeTeam <- sub_value_df(stats_epl$HomeTeam,'Man United', 'Manchester United')
stats_epl$HomeTeam <- sub_value_df(stats_epl$HomeTeam,'Norwich', 'Norwich City')
stats_epl$HomeTeam <- sub_value_df(stats_epl$HomeTeam,'Tottenham', 'Tottenham Hotspur')
stats_epl$AwayTeam <- sub_value_df(stats_epl$AwayTeam,'Bournemouth', 'AFC Bournemouth')
stats_epl$AwayTeam <- sub_value_df(stats_epl$AwayTeam,'Brighton', 'Brighton & Hove Albion')
stats_epl$AwayTeam <- sub_value_df(stats_epl$AwayTeam,'Leicester', 'Leicester City')
stats_epl$AwayTeam <- sub_value_df(stats_epl$AwayTeam,'Man City', 'Manchester City')
stats_epl$AwayTeam <- sub_value_df(stats_epl$AwayTeam,'Man United', 'Manchester United')
stats_epl$AwayTeam <- sub_value_df(stats_epl$AwayTeam,'Norwich', 'Norwich City')
stats_epl$AwayTeam <- sub_value_df(stats_epl$AwayTeam,'Tottenham', 'Tottenham Hotspur')

#Agregamos el flag de big_six
stats_epl['big_six_h'] <- sapply(stats_epl$HomeTeam,is_big_six)
stats_epl['big_six_a'] <- sapply(stats_epl$AwayTeam,is_big_six)
stats_epl['big_six'] <- if_else(stats_epl$big_six_a == 1 | stats_epl$big_six_h == 1,1,0)

#Escribimos la tabla final a la carpeta local

#declaramos la ruta final de la tabla
ruta_final_pl_stats <- paste(ruta_guardado,'stats_epl.csv',sep = "")
#lo escribimos
write_csv(stats_epl,ruta_final_pl_stats)
```

Una vista general de algunos registros de esta tabla es la siguiente:

```{r epl_stats_view}
head(stats_epl)
```

## Tabla 7: "fpl_merged_seasons". Fuente: GitHub - Fantasy-Premier-League

La tabla número 7 presentada aquí contiene datos acerca de algunas métricas de los partidos de la PL a nivel temporada, es decir, los datos que se recopilan estan a nivel jornada/temporada, no contiene una descripción más detallada de jugadores o equipos, por ejemplo. También es importante mencionar que estos datos son orientados a ser usados para el juego de [Fantasy Premier League](https://fantasy.premierleague.com) y por lo tanto, en esta tabla se incluyen otras métricas además de las "tradicionales" que se presentan para cada partido de la PL, estas métricas "inusuales" que se presentan en esta tabla van más orientados a mostrar, por ejemplo, el desempeño que tiene cada jugador y/o equipo durante cada partido de la PL, métricas que ayuden a medir el desempeño de cada jugador dentro de la PL jornada tras jornada. Algunas de estas métricas son las siguientes:

1. assists: Número de asistencias hechas por el jugador

2. bps: Bonus Points System, puntos que se le suman/restan al jugador de acuerdo a acciones que realiza durante el partido a manera de medir su desempeño en el mismo

3. creativity: Mide el desempeño del jugador en términos de oportunidades creadas de gol (mayormente derivadas en asistencias). Toma en cuenta frecuencia de pases, cruces, locación en la cancha y calidad de pase final

Los datos se obtuvieron a través del repositorio de GitHub [Fantasy-Premier-League](https://github.com/vaastav/Fantasy-Premier-League) y contiene data a partir de la temporada 2016/2017.

Para información más detallada de las variables que se presentan en esta tabla se puede consultar el repositorio de [GitHub](https://github.com/pedro-vr/var_epl/tree/main/tables/dictionaries).

```{r cleaned_merged_seasons, include=FALSE}
#Empezamos con el proceso de creación de la tabla acerca de la información detallada de los partidos y jugadores de la PL por cada temporada

#Leemos la data de todas las temporadas
cleaned_merged_seasons <- get_pl_merged_seasons(ruta_raw)

#Agregamos el nombre del equipo basado en el catálogo de equipos
cleaned_merged_seasons <- cleaned_merged_seasons %>% left_join(players_teams_catalog[c('id','season','team_name')], by = c('season','id_player' = 'id'))

#Homologamos el nombre de los equipos con las demás tablas

#Convertimos las columnas de equipos en character
cleaned_merged_seasons$team_name <- as.character(cleaned_merged_seasons$team_name)
cleaned_merged_seasons$opp_team_name <- as.character(cleaned_merged_seasons$opp_team_name)
#Sustituimos los nombres para homologar
cleaned_merged_seasons$team_name <- sub_value_df(cleaned_merged_seasons$team_name,'Brighton','Brighton & Hove Albion')
cleaned_merged_seasons$team_name <- sub_value_df(cleaned_merged_seasons$team_name,'Leicester','Leicester City')
cleaned_merged_seasons$team_name <- sub_value_df(cleaned_merged_seasons$team_name,'Man City','Manchester City')
cleaned_merged_seasons$team_name <- sub_value_df(cleaned_merged_seasons$team_name,'Man Utd','Manchester United')
cleaned_merged_seasons$team_name <- sub_value_df(cleaned_merged_seasons$team_name,'Norwich','Norwich City')
cleaned_merged_seasons$team_name <- sub_value_df(cleaned_merged_seasons$team_name,'Sheffield Utd','Sheffield United')
cleaned_merged_seasons$team_name <- sub_value_df(cleaned_merged_seasons$team_name,'Spurs','Tottenham Hotspur')

cleaned_merged_seasons$opp_team_name <- sub_value_df(cleaned_merged_seasons$opp_team_name,'Bournemouth','AFC Bournemouth')
cleaned_merged_seasons$opp_team_name <- sub_value_df(cleaned_merged_seasons$opp_team_name,'Brighton','Brighton & Hove Albion')
cleaned_merged_seasons$opp_team_name <- sub_value_df(cleaned_merged_seasons$opp_team_name,'Leicester','Leicester City')
cleaned_merged_seasons$opp_team_name <- sub_value_df(cleaned_merged_seasons$opp_team_name,'Man City','Manchester City')
cleaned_merged_seasons$opp_team_name <- sub_value_df(cleaned_merged_seasons$opp_team_name,'Man Utd','Manchester United')
cleaned_merged_seasons$opp_team_name <- sub_value_df(cleaned_merged_seasons$opp_team_name,'Norwich','Norwich City')
cleaned_merged_seasons$opp_team_name <- sub_value_df(cleaned_merged_seasons$opp_team_name,'Sheffield Utd','Sheffield United')
cleaned_merged_seasons$opp_team_name <- sub_value_df(cleaned_merged_seasons$opp_team_name,'Spurs','Tottenham Hotspur')

#Agregamos las columnas de big_six

#Creamos columnas auxiliares nuevas para facilitar la lógica
cleaned_merged_seasons['bs_t'] <- sapply(cleaned_merged_seasons$team1, is_big_six)
cleaned_merged_seasons['bs_ot'] <- sapply(cleaned_merged_seasons$opp_team_name, is_big_six)

#Aplicamos las reglas para big_six
cleaned_merged_seasons['big_six_h'] <- if_else((cleaned_merged_seasons$bs_t == 1 & cleaned_merged_seasons$was_home == 'True') | (cleaned_merged_seasons$bs_ot == 1 & cleaned_merged_seasons$was_home == 'False'),1,0)
cleaned_merged_seasons['big_six_a'] <- if_else((cleaned_merged_seasons$bs_t == 1 & cleaned_merged_seasons$was_home == 'False') | (cleaned_merged_seasons$bs_ot == 1 & cleaned_merged_seasons$was_home == 'True'),1,0)
cleaned_merged_seasons['big_six'] <- if_else(cleaned_merged_seasons$big_six_h == 1 | cleaned_merged_seasons$big_six_a == 1,1,0)

#Eliminamos las columnas auxiliares
cleaned_merged_seasons <- cleaned_merged_seasons %>% select(.,-c('bs_t','bs_ot'))

#Escribimos la tabla final a la carpeta local

#declaramos la ruta final de la tabla
ruta_final_pl_merged_seasons <- paste(ruta_guardado,'fpl_merged_seasons.csv',sep = "")
#Lo escribimos
write_csv(cleaned_merged_seasons,ruta_final_pl_merged_seasons)
```

Una vista general de algunos registros de esta tabla es la siguiente:

```{r cleaned_merged_seasons_view}
head(cleaned_merged_seasons)
```

## Tabla 8: "fpl_merged_players". Fuente: GitHub - Fantasy-Premier-League

La tabla número 8 que se presenta aquí, al igual que la número 7, representa datos orientados al juego de Fantasy Premier League, por lo que las variables que podemos esperar aquí también son datos que ayudan a describir el desempeño de los jugadores jornada tras jornada de la PL. La principal diferencia de esta tabla con la número 7 es que esta tabla está a nivel jugador, es decir, estas métricas estan dedicadas a dar un mejor detalle de las características del jugador y, a su vez, a dar detalles de su desempeño jornada tras jornada de la PL, pero la estructura es en esencia la misma. Algunas de las métricas que se presentan en esta tabla son las siguientes:

1. threat: Puntaje total atribuido a la amenaza que implicaba el jugador de acuerdo a FPL en la temporada correspondiente de la PL

2. position_name: Posición del jugador dentro del campo de juego

3. clean_sheets: Número total de porterías imbatidas acumuladas por el jugador en la temporada correspondiente de la PL

Los datos se obtuvieron a través del repositorio de GitHub [Fantasy-Premier-League](https://github.com/vaastav/Fantasy-Premier-League) y contiene data a partir de la temporada 2016/2017.

Para información más detallada de las variables que se presentan en esta tabla se puede consultar el repositorio de [GitHub](https://github.com/pedro-vr/var_epl/tree/main/tables/dictionaries).

```{r fpl_merged_players,include=FALSE}
#leemos la data
cleaned_players_1617 <- get_pl_merged_players(ruta_raw,'16/17')
cleaned_players_1718 <- get_pl_merged_players(ruta_raw,'17/18')
cleaned_players_1819 <- get_pl_merged_players(ruta_raw,'18/19')
cleaned_players_1920 <- get_pl_merged_players(ruta_raw,'19/20')
cleaned_players_2021 <- get_pl_merged_players(ruta_raw,'20/21')
cleaned_players_2122 <- get_pl_merged_players(ruta_raw,'21/22')

#unimos todos en uno solo
merged_cleaned_players <- cleaned_players_1617 %>% bind_rows(cleaned_players_1718) %>% bind_rows(cleaned_players_1819) %>% bind_rows(cleaned_players_1920) %>% bind_rows(cleaned_players_2021) %>% bind_rows(cleaned_players_2122)

#juntamos nombre y apellido del jugador y creamos nueva variable
merged_cleaned_players <- merged_cleaned_players %>% mutate(name = paste(first_name,second_name))

#Convertimos la variable de nombre al tipo character
merged_cleaned_players$name <- as.character(merged_cleaned_players$name)

#Transformamos los carácteres especiales dentro de los nombres
merged_cleaned_players$name <- sapply(merged_cleaned_players$name,gsub,pattern="<e9>",replacement="é")
merged_cleaned_players$name <- sapply(merged_cleaned_players$name,gsub,pattern="<e1>",replacement="á")
merged_cleaned_players$name <- sapply(merged_cleaned_players$name,gsub,pattern="<e8>",replacement="e")
merged_cleaned_players$name <- sapply(merged_cleaned_players$name,gsub,pattern="<fa>",replacement="ú")
merged_cleaned_players$name <- sapply(merged_cleaned_players$name,gsub,pattern="<f1>",replacement="n")
merged_cleaned_players$name <- sapply(merged_cleaned_players$name,gsub,pattern="<f3>",replacement="ó")
merged_cleaned_players$name <- sapply(merged_cleaned_players$name,gsub,pattern="<e0>",replacement="á")
merged_cleaned_players$name <- sapply(merged_cleaned_players$name,gsub,pattern="<ed>",replacement="í")
merged_cleaned_players$name <- sapply(merged_cleaned_players$name,gsub,pattern="<eb>",replacement="e")
merged_cleaned_players$name <- sapply(merged_cleaned_players$name,gsub,pattern="<f6>",replacement="o")
merged_cleaned_players$name <- sapply(merged_cleaned_players$name,gsub,pattern="<fc>",replacement="u")
merged_cleaned_players$name <- sapply(merged_cleaned_players$name,gsub,pattern="<ef>",replacement="i")
merged_cleaned_players$name <- sapply(merged_cleaned_players$name,gsub,pattern="<d6>",replacement="O")
merged_cleaned_players$name <- sapply(merged_cleaned_players$name,gsub,pattern="<f8>",replacement="o")
merged_cleaned_players$name <- sapply(merged_cleaned_players$name,gsub,pattern="<f5>",replacement="o")
merged_cleaned_players$name <- sapply(merged_cleaned_players$name,gsub,pattern="<e5>",replacement="a")
merged_cleaned_players$name <- sapply(merged_cleaned_players$name,gsub,pattern="<c1>",replacement="Á")
merged_cleaned_players$name <- sapply(merged_cleaned_players$name,gsub,pattern="<e4>",replacement="a")

#Completamos la columna de la posición del jugador
merged_cleaned_players <- set_player_position(merged_cleaned_players,cleaned_merged_seasons)
#Completamos la columna del nombre del equipo
merged_cleaned_players <- set_team_name(merged_cleaned_players,players_teams_catalog)

#Escribimos la tabla final a la carpeta local

#declaramos la ruta final de la tabla
ruta_final_pl_merged_players <- paste(ruta_guardado,'fpl_merged_players.csv',sep = "")
#Lo escribimos
write_csv(merged_cleaned_players,ruta_final_pl_merged_players)
```

Una vista general de algunos registros de esta tabla es la siguiente:

```{r fpl_merged_players_view}
head(merged_cleaned_players)
```
## Tabla 9: "fpl_merged_gw". Fuente: GitHub - Fantasy-Premier-League

La tabla número 9 que se presenta aquí tiene el mismo fin que el de las tablas 7 y 8, representar información orientada al juego Fantasy Premier League, por lo que aquí también podemos esperar datos que representen el desemnpeño de los jugadores y/o equipos jornada tras jornada de la PL. La principal diferencia de esta tabla con las anteriores dos es que aquí la información está a nivel jornada, es decir, aquí se presenta información mas detallada con respecto a cada jornada y con la descripción de cada uno en detalle, pero la estructura es en esencia la misma. Algunas de las métricas que se presentan en esta tabla son las siguientes:

1. big_chances_created: Número total de grandes oportunidades creadas, hacia gol, por el jugador en la jornada correspondiente de la PL

2. completed_passes: Número total de pases completados hechos por el jugador en la jornada correspondiente de la PL

3. penalties_conceded: Número total de penalties concedidos por el jugador en la jornada correspondiente de la PL 

Los datos se obtuvieron a través del repositorio de GitHub [Fantasy-Premier-League](https://github.com/vaastav/Fantasy-Premier-League) y contiene data a partir de la temporada 2016/2017.

Para información más detallada de las variables que se presentan en esta tabla se puede consultar el repositorio de [GitHub](https://github.com/pedro-vr/var_epl/tree/main/tables/dictionaries).

```{r merged_gw_formatted,include=FALSE}
#leemos la data
merged_gw_1617 <- get_pl_merged_gw(ruta_raw,'16/17')
merged_gw_1718 <- get_pl_merged_gw(ruta_raw,'17/18')
merged_gw_1819 <- get_pl_merged_gw(ruta_raw,'18/19')
merged_gw_1920 <- get_pl_merged_gw(ruta_raw,'19/20')
merged_gw_2021 <- get_pl_merged_gw(ruta_raw,'20/21')
merged_gw_2122 <- get_pl_merged_gw(ruta_raw,'21/22')

#unimos la data
merged_gw <- merged_gw_1617 %>% bind_rows(merged_gw_1718) %>% bind_rows(merged_gw_1819) %>% bind_rows(merged_gw_1920) %>% bind_rows(merged_gw_2021) %>% bind_rows(merged_gw_2122)

#eliminamos columnas
merged_gw <- merged_gw %>% select(.,-c('ea_index','fixture','id','kickoff_time_formatted','round','selected','value'))

#empezamos proceso de la limpieza de la data

#corregimos nombres: quitarle guión bajo y acentos 
merged_gw$name <- as.character(merged_gw$name)
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<e9>",replacement="é")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<e1>",replacement="á")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<e8>",replacement="e")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<fa>",replacement="ú")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<f1>",replacement="n")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<f3>",replacement="ó")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<e0>",replacement="á")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<ed>",replacement="í")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<eb>",replacement="e")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<f6>",replacement="o")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<fc>",replacement="u")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<ef>",replacement="i")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<d6>",replacement="O")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<f8>",replacement="o")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<f5>",replacement="o")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<e5>",replacement="a")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<c1>",replacement="Á")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<e4>",replacement="a")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<e3>",replacement="a")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<df>",replacement="ss")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<e7>",replacement="c")
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="<c7>",replacement="c")
merged_gw$name <- sapply(merged_gw$name,remove_numbers)
merged_gw$name <- sapply(merged_gw$name,gsub,pattern="_",replacement=" ")

#Modificamos la columna del nombre del equipo local
merged_gw <- set_local_team_name(merged_gw,players_teams_catalog)

#Modificamos la columna del nombre del equipo oponente
merged_gw_formatted <- set_opponent_team_name(merged_gw,players_teams_catalog)

#Homologamos el nombre de los equipos con los demas dfs
merged_gw_formatted$team_name <- as.character(merged_gw_formatted$team_name)
merged_gw_formatted$opponent_team <- as.character(merged_gw_formatted$opponent_team)
merged_gw_formatted$team_name[is.na(merged_gw_formatted$team_name)] <- ""
merged_gw_formatted$opponent_team[is.na(merged_gw_formatted$opponent_team)] <- ""

merged_gw_formatted$team_name <- sub_value_df(merged_gw_formatted$team_name,'Brighton','Brighton & Hove Albion')
merged_gw_formatted$team_name <- sub_value_df(merged_gw_formatted$team_name,'Leicester','Leicester City')
merged_gw_formatted$team_name <- sub_value_df(merged_gw_formatted$team_name,'Man City','Manchester City')
merged_gw_formatted$team_name <- sub_value_df(merged_gw_formatted$team_name,'Man Utd','Manchester United')
merged_gw_formatted$team_name <- sub_value_df(merged_gw_formatted$team_name,'Norwich','Norwich City')
merged_gw_formatted$team_name <- sub_value_df(merged_gw_formatted$team_name,'Sheffield Utd','Sheffield United')
merged_gw_formatted$team_name <- sub_value_df(merged_gw_formatted$team_name,'Spurs','Tottenham Hotspur')

merged_gw_formatted$opponent_team <- sub_value_df(merged_gw_formatted$opponent_team,'Bournemouth','AFC Bournemouth')
merged_gw_formatted$opponent_team <- sub_value_df(merged_gw_formatted$opponent_team,'Brighton','Brighton & Hove Albion')
merged_gw_formatted$opponent_team <- sub_value_df(merged_gw_formatted$opponent_team,'Leicester','Leicester City')
merged_gw_formatted$opponent_team <- sub_value_df(merged_gw_formatted$opponent_team,'Man City','Manchester City')
merged_gw_formatted$opponent_team <- sub_value_df(merged_gw_formatted$opponent_team,'Man Utd','Manchester United')
merged_gw_formatted$opponent_team <- sub_value_df(merged_gw_formatted$opponent_team,'Norwich','Norwich City')
merged_gw_formatted$opponent_team <- sub_value_df(merged_gw_formatted$opponent_team,'Sheffield Utd','Sheffield United')
merged_gw_formatted$opponent_team <- sub_value_df(merged_gw_formatted$opponent_team,'Spurs','Tottenham Hotspur')

#Agregamos el flag de big six

#Creamos columnas auxiliares nuevas para hacer más fácil la comparación
merged_gw_formatted['bs_t'] <- sapply(merged_gw_formatted$team_name, is_big_six)
merged_gw_formatted['bs_ot'] <- sapply(merged_gw_formatted$opponent_team, is_big_six)

#aplicamos las reglas para big_six
merged_gw_formatted['big_six_h'] <- if_else((merged_gw_formatted$bs_t == 1 & merged_gw_formatted$was_home == 'True') | (merged_gw_formatted$bs_ot == 1 & merged_gw_formatted$was_home == 'False'),1,0)
merged_gw_formatted['big_six_a'] <- if_else((merged_gw_formatted$bs_t == 1 & merged_gw_formatted$was_home == 'False') | (merged_gw_formatted$bs_ot == 1 & merged_gw_formatted$was_home == 'True'),1,0)
merged_gw_formatted['big_six'] <- if_else(merged_gw_formatted$big_six_h == 1 | merged_gw_formatted$big_six_a == 1,1,0)

#eliminamos las columnas auxiliares
merged_gw_formatted <- merged_gw_formatted %>% select(.,-c('bs_t','bs_ot'))

#Escribimos la tabla final a la carpeta local

#declaramos la ruta final de la tabla
ruta_final_pl_merged_gw <- paste(ruta_guardado,'fpl_merged_gw.csv',sep = "")
#Lo escribimos
write_csv(merged_gw_formatted,ruta_final_pl_merged_gw)
```

Una vista general de algunos registros de esta tabla es la siguiente:

```{r merged_gw_formatted_view}
head(merged_gw_formatted)
```

## Tabla 10: "poss_stats". Fuente: FBREF

La tabla número 10 que se presenta aquí contiene el resumen de algunas estadísticas muy generales acerca de los equipos de la PL temporada tras temporada, estas estadísticas podrían pensarse como aquellas que describen de manera muy general el desempeño de los equipos de la PL a través de cada temporada, desde los minutos jugados, hasta el tiempo de posesión en general del equipo durante toda la temporada. La data que se presenta aquí es desde la temporada 2016/2017 al día de hoy. 

Algunas de las variables que se presentan en esta tabla son las siguientes:

1. goals_scored_90: Número de goles anotados por cada 90 mins en la temporada

2. assists_90: Número de asistencias hechas por cada 90 mins en la temporada

3. poss: Porcentaje de posesión total del balón en la temporada

Los datos aquí consultados se obtuvieron de la página [FBREF](https://fbref.com/en/comps/9/2021-2022/2021-2022-Premier-League-Stats) (página de ejemplo para la temporada 2021-2022).

Para información más detallada de las variables que se presentan en esta tabla se puede consultar el repositorio de [GitHub](https://github.com/pedro-vr/var_epl/tree/main/tables/dictionaries).

```{r poss_stats,include=FALSE}

#leemos la data
poss_stats <- get_poss_stats(ruta_raw)

#hacemos cambio de nombre de los equipos para homologar con demas dfs
poss_stats$team <- sub_value_df(poss_stats$team,'Bournemouth','AFC Bournemouth')
poss_stats$team <- sub_value_df(poss_stats$team,'Brighton','Brighton & Hove Albion')
poss_stats$team <- sub_value_df(poss_stats$team,'Cardiff City','Cardiff')
poss_stats$team <- sub_value_df(poss_stats$team,'Hull City','Hull')
poss_stats$team <- sub_value_df(poss_stats$team,'Leeds United','Leeds')
poss_stats$team <- sub_value_df(poss_stats$team,'Manchester Utd','Manchester United')
poss_stats$team <- sub_value_df(poss_stats$team,'Newcastle Utd','Newcastle')
poss_stats$team <- sub_value_df(poss_stats$team,'Sheffield Utd','Sheffield United')
poss_stats$team <- sub_value_df(poss_stats$team,'Stoke City','Stoke')
poss_stats$team <- sub_value_df(poss_stats$team,'Swansea City','Swansea')
poss_stats$team <- sub_value_df(poss_stats$team,'Tottenham','Tottenham Hotspur')

#Escribimos la tabla final a la carpeta local

#declaramos la ruta final de la tabla
ruta_final_poss_stats <- paste(ruta_guardado,'epl_poss_stats.csv',sep = "")
#Lo escribimos
write_csv(poss_stats,ruta_final_poss_stats)
```

Una vista general de algunos registros de esta tabla es la siguiente:

```{r poss_stats_view}
head(poss_stats)
```

## Tabla 11: "pl_action_zones". Fuente: WhoScored.com

```{r action_zones,include=FALSE}

#leemos la data
action_zones <- get_action_zones(ruta_raw)

#hacemos cambio de nombre de los equipos para homologar con demas dfs
poss_stats$team <- sub_value_df(poss_stats$team,'Bournemouth','AFC Bournemouth')
poss_stats$team <- sub_value_df(poss_stats$team,'Brighton','Brighton & Hove Albion')
poss_stats$team <- sub_value_df(poss_stats$team,'Cardiff City','Cardiff')
poss_stats$team <- sub_value_df(poss_stats$team,'Hull City','Hull')
poss_stats$team <- sub_value_df(poss_stats$team,'Leeds United','Leeds')
poss_stats$team <- sub_value_df(poss_stats$team,'Manchester Utd','Manchester United')
poss_stats$team <- sub_value_df(poss_stats$team,'Newcastle Utd','Newcastle')
poss_stats$team <- sub_value_df(poss_stats$team,'Sheffield Utd','Sheffield United')
poss_stats$team <- sub_value_df(poss_stats$team,'Stoke City','Stoke')
poss_stats$team <- sub_value_df(poss_stats$team,'Swansea City','Swansea')
poss_stats$team <- sub_value_df(poss_stats$team,'Tottenham','Tottenham Hotspur')

#Escribimos la tabla final a la carpeta local

#declaramos la ruta final de la tabla
ruta_final_action_zones <- paste(ruta_guardado,'pl_action_zones.csv',sep = "")
#Lo escribimos
write_csv(action_zones,ruta_final_action_zones)
```

Una vista general de algunos registros de esta tabla es la siguiente:

```{r action_zones_view}
head(poss_stats)
```

Una vez obtenida toda esta data, lo que se pretende lograr a continuación es el análisis estadístico de tipo descriptivo, predictivo e inferencial del VAR para con el fútbol profesional inglés a través de las últimas temporadas vs las temporadas anteriores en que el VAR no existía como una realidad dentro del fútbol profesional. 
